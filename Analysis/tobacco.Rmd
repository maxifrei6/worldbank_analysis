---
title: "World Bank Tobacco Analysis"
author: "Robin Billinger, Leonie Mertes"
date: "2025-01-20"
output:
  html_document:
    self-contained: true
    clean: true
---

## Introduction
This analysis explores relationships between indicators across countries such as GDP per capita and prevalence of current tobacco usage (% of adults) using World Bank data. The question to be investigated is:
<br><br>
1. How does **GDP per capita** relate to the **prevalence of current tobacco use (% of adults)**?
<br><br>
The upon mentioned indicators taken into consideration during this analysis are defined in the following table.

```{r tobacco_setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load libraries
library(knitr)
library(here)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(tidyr)
library(patchwork)
library(gridExtra)

# Source self-written functions using 'here'
source(here("Scripts", "functions.R"))

# Globally center all plots while displaying knitted version in HTML
knitr::opts_chunk$set(fig.align = "center")

# Create dictionary table to get overview over variables to work with
# Variables:  GDP per capita, PPP (constant 2021 international $)
#             NY.GDP.PCAP.PP.KD
#
#             Prevalence of current tobacco use (% of adults)
#             SH.PRV.SMOK
dictionary <- data.frame(
  Variable = c("NY.GDP.PCAP.PP.KD",
               "SH.PRV.SMOK"),
  `Indicator Name` = c("GDP per capita, PPP (constant 2021 international $)",
                       "Prevalence of current tobacco use (% of adults)"),
  Definition = c(
    paste0("GDP per capita based on purchasing power parity (PPP). PPP GDP is gross ",
           "domestic product converted to international dollars using purchasing power ",
           "parity rates. An international dollar has the same purchasing power over ",
           "GDP as the U.S. dollar has in the United States. GDP at purchaser's prices ",
           "is the sum of gross value added by all resident producers in the country ",
           "plus any product taxes and minus any subsidies not included in the value of ",
           "the products. It is calculated without making deductions for depreciation ",
           "of fabricated assets or for depletion and degradation of natural resources. ",
           "Data are in constant 2021 international dollars."),
    paste0("The percentage of the population ages 15 years and over who currently use ",
           "any tobacco product (smoked and/or smokeless tobacco) on a daily or non-",
           "daily basis. Tobacco products include cigarettes, pipes, cigars, cigarillos,",
           " waterpipes (hookah, shisha), bidis, kretek, heated tobacco products, and ",
           "all forms of smokeless (oral and nasal) tobacco. Tobacco products exclude ",
           "e-cigarettes (which do not contain tobacco), “e-cigars”, “e-hookahs”, JUUL ",
           "and “e-pipes”. The rates are age-standardized to the WHO Standard ",
           "Population.")),
  check.names = FALSE
)
kable(dictionary, caption = "World Bank Indicators", align = c("c", "c", "c"))

# Load the 'data_merged' dataset
data_tobacco <- readRDS(here("Data", "Processed", "data_merged.RDS"))

# Filter relevant columns Country Name and Code, Year, NY.GDP.PCAP.PP.KD, SH.PRV.SMOK and
# cat_tob_usage
data_tobacco <-
  left_join(data_tobacco,
            readRDS(here("Data", "Processed", "data_grouped.RDS")),
            by = c("Country Name", "Country Code")) %>%
  select(`Country Name`, `Country Code`, Year,
         NY.GDP.PCAP.PP.KD, SH.PRV.SMOK, cat_tob_usage)
```
(*Sources: https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD?view=chart, https://data.worldbank.org/indicator/SH.PRV.SMOK?view=chart*)

## Grouping of the countries
The countries are grouped by their Prevalence of current tobacco use based on the quantiles of the average values of the tobacco variable. In the following, they are categorized into five categories. 
<br>
Since it is not always helpful to group over the average, an annual grouping is also used in the course of the script. Here, each country was categorized by quantiles over the tobacco variable each year.
<br><br>

## Terminology and Methodological Approach
To mitigate issues with data quality and variance in data, we employ robust statistical techniques, including:

- **Robust Linear Models (RLMs)** for trend estimation, which are less sensitive to **outliers**.
- **Confidence Intervals** to provide insight into the **uncertainty of our estimates**.

#### Robust Linear Models

Traditional **Ordinary Least Squares (OLS)** estimates regression coefficients by minimizing the sum of squared residuals:

$$
\min_{\beta} \sum_{i=1}^{n} (y_i - X_i \beta)^2
$$

This approach provides **BLUE (Best Linear Unbiased Estimators)** under the **Gauss-Markov theorem**, but relies on the assumption that residuals are **normally distributed**. Given the inconsistencies in our dataset, this assumption is likely invalid. While OLS estimates remain **unbiased** but may become less efficient, potentially affecting the reliability of **confidence intervals and hypothesis tests**.

To address this, we use **Robust Linear Models (RLMs)**, specifically M-estimators, as implemented in `MASS::rlm()`. These models apply **Iteratively Reweighted Least Squares (IRLS)**, assigning smaller weights to outliers. Instead of minimizing squared residuals, RLMs use **alternative loss functions** that reduce the impact of extreme values.

In our analysis, we use the default psi function, **psi.huber**, which is based on **Huber’s loss function**:

$$
L_{\delta}(r) =
\begin{cases} 
\frac{1}{2} r^2  & \text{for } |r| \leq \delta, \\
\delta (|r| - \frac{1}{2} \delta)  & \text{for } |r| > \delta.
\end{cases}
$$

where:

- \( r \) is the **residual** \(y_i - X_i \beta\)
- \( \delta \) is the **threshold parameter** (default in R: **1.345**)  

This method ensures **small residuals** behave like **OLS**, while **large residuals** have **reduced influence**, making RLMs more resistant to **outliers and non-normal residual distributions**.

<br>

#### Confidence Intervals

By default, `geom_smooth(method = MASS::rlm)` displays confidence intervals. However, unlike **ordinary least squares (OLS)**, `MASS::rlm()` does **not automatically provide standard errors**, as robust regression does not make the same assumptions about variability in the data.  

The confidence intervals shown in `geom_smooth()` are based on an **approximation** rather than **true robust standard errors**. Specifically, `ggplot2` estimates confidence intervals using the **standard formula for least squares regression**:

$$
CI = \hat{y} \pm t_{\alpha/2, df} \cdot SE(\hat{y})
$$


where:

- \( \hat{y} \) is the **predicted value** from the robust regression model
- \( SE(\hat{y}) \) is the **standard error of the fitted values**, approximated using **local smoothing techniques**
- \( t_{\alpha/2, df} \) is the **critical t-value** for a 95% confidence level

Since robust regression methods like `rlm()` do not inherently calculate standard errors, the confidence intervals shown by `geom_smooth()` are **only an approximation**. A more rigorous approach would involve computing **robust standard errors manually** using the **Huber-White sandwich estimator** or **bootstrapping techniques**.

For simplicity, we retain the default confidence bands provided by `geom_smooth()`, while acknowledging that they do not fully account for the robustness adjustments of `rlm()`.

## Agenda
1.) GDP per capita and prevalence of current tobacco usage
<br><br>
1.1.) Exploration of data with general grouping and application of yearly grouping
<br><br>
1.2.) Scatter plot of interested variables
<br><br>
1.3.) Scatter plot of interested variables; except outlier Qatar
<br><br>
1.4.) Scatter plot of interested variables with faceted years
<br><br>
1.5.) Scatter plot of interested variables with faceted years with density curves
<br><br>
1.6.) Kullback-Leibler divergence for tobacco usage
<br><br>

### 1. GDP per capita and prevalence of current tobacco use
We analyze how the GDP per capita for the observed countries relates to the prevalence of current tobacco use, representing the percentage of adults currently consuming tobacco. To get an overview over the interested data and be able to evaluate future insights correctly, we start by looking at the data available to us.
<br><br>

```{r missing_countries, echo=FALSE, message=FALSE, warning=FALSE}
# Check whether any missing values in interested data subset
paste0("Are there no missing values? - Answer: ", all(!is.na(data_tobacco)))
paste0("How many missing values are in the data regarding GDP per capita? - Answer: ",
       sum(is.na(data_tobacco$NY.GDP.PCAP.PP.KD)))
paste0("How many missing values are in the data regarding tobacco prevalence? - Answer: ",
       sum(is.na(data_tobacco$SH.PRV.SMOK)))

# Check whether any countries with completely missing data.
data_tobacco %>%
  group_by(`Country Name`) %>%
  count(SH.PRV.SMOK) %>%
  filter(is.na(SH.PRV.SMOK)) %>%
  filter(n == 22)
```

As we can see, there is no data available for Aruba during the 22 years of time stretching from 2000 to 2021. Therefore, we drop Aruba from our analysis. Further, we check if there are any years in which the data is missing for several countries at the same time.

```{r missing_years, echo=FALSE, message=FALSE, warning=FALSE}
# Check which years are given for each of the other countries
data_tobacco_years_available <-
  data_tobacco %>%
  group_by(Year) %>%
  reframe(count_na = sum(is.na(SH.PRV.SMOK))) %>%
  filter(count_na < 25)
print(data_tobacco_years_available)

# As data to "Aruba" only contains NAs, remove Aruba from dataset
data_tobacco <- data_tobacco[data_tobacco$`Country Name` != "Aruba", ]
```

Knowing there are only 25 countries to investigate, we only have data of the years 2000, 2005, 2010, 1015, 1018, 2019 and 2020 on percentage of tobacco usage in the adult population of all 24 countries (excluding Aruba). We adjust our data accordingly, so that those years will be the only ones we are considering when moving forward.

```{r missing_filter, echo=FALSE, message=FALSE}
# Intermediate save of the whole 'data_tobacco' set before removing missing tobacco years
data_tob_all <- data_tobacco

# As we only have data on each country for the years 2000, 2005, 2010, 2015, 2018, 2019,
# and 2020, we remove all missing years for each country
data_tobacco <- data_tobacco %>%
  filter(Year %in% data_tobacco_years_available$Year)

# Copy the 'data_tobacco' data frame to another variable to simplify the fusion of the
# analysis done by two separate team members
data_tob <- data_tobacco
```

```{r tobL_3, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Grouping per year: Setting up according data frames
# Grouping by tobacco values each year and saving this full dataset in data_tob_per_year using function 2.2 group_data_year
data_tob_per_year <- data_tob %>%
  group_by(Year) %>%
  mutate(
    cat_tob_usage_per_year =
      group_data_year(
        df = data_tob,
        grouping_by = "SH.PRV.SMOK",
        year = Year,
        column_new = "tob_usage_per_year",
        quantile_labels = c("Sehr gering", "Gering", "Mittel", "Groß", "Sehr groß")
      )$cat_tob_usage_per_year
  )

# partly we need the labels in slightly different format, therefore:
data_tob_per_year_format <- data_tob %>%
  group_by(Year) %>%
  mutate(
    cat_tob_usage_per_year =
      group_data_year(
        df = data_tob,
        grouping_by = "SH.PRV.SMOK",
        year = Year,
        column_new = "tob_usage_per_year",
        quantile_labels = c("Sehr\ngering", "Gering", "Mittel", "Groß", "Sehr\ngroß")
      )$cat_tob_usage_per_year
  )
```

#### 1.1. Exploration of data with general grouping and derivation/application of yearly grouping
For an overview we take a look at the comparison of tobacco usage and GDP in 2020, our most recent data. We add an linear regression line to get a better impression on the overall coherence.<br>

```{r tobL_1, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
tob_gdp_2020 <- data_tob %>%
  filter(Year == 2020) %>%
  group_by(cat_tob_usage) %>%
  ggplot(aes(SH.PRV.SMOK, NY.GDP.PCAP.PP.KD)) +
  geom_point(size = 3, alpha = 0.6) +
  theme_bw() +
  labs(
    x = "Anteil der tabakkonsumierenden Erwachsenen [%]",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP im Jahr 2020"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = TRUE, colour = "black", alpha = 0.3, size = 0.7)

tob_gdp_2020
```
 
<br> If we take the general categorization of the countries by the tobacco variable into account and plot only one point per group by calculating their mean, the following plot is created. <br>

```{r tobL_2, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
tob_gdp_facetyear_grouped <- data_tob %>%
  group_by(cat_tob_usage, Year) %>%
  summarise(
    NY.GDP.PCAP.PP.KD = mean(NY.GDP.PCAP.PP.KD, na.rm = TRUE),
    SH.PRV.SMOK = mean(SH.PRV.SMOK, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SH.PRV.SMOK, NY.GDP.PCAP.PP.KD)) +
  facet_wrap( ~ Year, ncol = 4) +
  geom_point(aes(fill = cat_tob_usage), size = 3, alpha = 0.7, shape = 21) +
  scale_fill_viridis_d(name = "relativer Tabakkonsum",
                       option = "plasma",
                       direction = -1) +
  theme_bw() +
  labs(
    x = "Anteil der tabakkonsumierenden Erwachsenen [%]",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP alle Jahre - allgemeine Gruppierung"
  ) +
  theme(legend.position = "bottom")

tob_gdp_facetyear_grouped
```
<br> Here we see that the grouping is not appropriate for each year. For example, in the years 2000 and 2005 we see that countries with relative medium tobacco use have on average a larger proportion of tobacco users than countries belonging to the group of relative high tobacco use. So there appear to be countries that have such fluctuating tobacco use rates over the years that they belong to different groups depending on the year. <br>
This can be seen particularly well in the plot below. Here, the outlier belongs to different groups over the years. We look at the annual grouping of countries according to the quantils of their tobacco variables of the corresponding year.<br>
In the following plot, all data points are visible. This also shows that the annual grouping creates correct classifications. <br> <br>
```{r tobL_4, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
tob_gdp_facetyear_yearlygrouped <- data_tob_per_year %>%
  ggplot(aes(SH.PRV.SMOK, NY.GDP.PCAP.PP.KD)) +
  facet_wrap( ~ Year, ncol = 4) +
  geom_point(aes(fill = cat_tob_usage_per_year), size = 2.5, alpha = 0.6, shape = 21) +
  scale_fill_viridis_d(name = "relativer Tabakkonsum",
                       option = "plasma",
                       direction = -1) +
  theme_bw() +
  labs(
    x = "Anteil der tabakkonsumierenden Erwachsenen [%]",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP - jährlich gruppierte Daten"
  ) +
  theme(legend.position = "bottom")

tob_gdp_facetyear_yearlygrouped
```

<br> Now, if we apply the new grouping to a bar plot showing the average values of all years for each group, the distribution is as follows: <br>

```{r tobL_5, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left", fig.height=5, fig.width=8}
tob_gdp_barplot_yearlygrouped <- data_tob_per_year %>%
  group_by(cat_tob_usage_per_year) %>%
  summarise(
    NY.GDP.PCAP.PP.KD = mean(NY.GDP.PCAP.PP.KD, na.rm = TRUE),
    .groups = "drop"
    ) %>%
  ggplot(aes(x = cat_tob_usage_per_year, y = NY.GDP.PCAP.PP.KD)) +
  geom_col() +
  theme_bw() +
  labs(
    x = "relativer Tabakkonsum",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP - jährlich gruppierte Daten"
  )

tob_gdp_barplot_yearlygrouped
```
<br> Now we want to include the dispersion of the HIV values in each group, to counteract any bias through averaging calculations. To do this, we now look at boxplots for each category. <br> <br>
```{r tobL_6, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_tob_cat_n <- data_tob_per_year %>%
  group_by(cat_tob_usage_per_year) %>%
  summarise(n = n())

xlabels <- paste0(sort(unique(data_tob_per_year$cat_tob_usage_per_year)), "\nn = ", data_tob_cat_n$n)

tob_gdp_boxplot_yearlygrouped <- data_tob_per_year %>%
  ggplot(aes(cat_tob_usage_per_year, NY.GDP.PCAP.PP.KD)) +
  geom_boxplot() +
  scale_y_log10(labels = scales::comma) +
  scale_x_discrete(labels = xlabels) +
  theme_bw() +
  labs(
    x = "relativer Tabakkonsum",
    y = "BIP pro Kopf [$] (log10)",
    title = "Tabakkonsum und BIP - jährlich gruppierte Daten"
  )

tob_gdp_boxplot_yearlygrouped
```
<br> This shows that the average calculations are representative of the data because they are similar to the distribution by the medians. <br>
The following bar plots visualize the relationship between GDP and tobacco use quite well.<br>

```{r tobL_7, echo=FALSE, fig.align="left", message=FALSE, warning=FALSE, fig.height=6, fig.width=11}
data_tob_per_year_format %>%
  group_by(cat_tob_usage_per_year, Year) %>%
  summarise(NY.GDP.PCAP.PP.KD = mean(NY.GDP.PCAP.PP.KD, na.rm = TRUE)) %>% 
  ggplot(aes(x = cat_tob_usage_per_year, y = NY.GDP.PCAP.PP.KD)) +
  geom_col() +
  facet_wrap( ~ Year, ncol = 4) +
  theme_bw() +
  labs(
    x = "relativer Tabakkonsum",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP - jährlich gruppierte Daten"
  )

# Note: The following plot is the original version of the presentation plot used during
# the presentation held on 2025/01/20. For reproducibility purposes, the original plot
# remains in the code; for the feedback-adjusted version, refer to plotting code below.
# Moving forward, we will only mark the first version with '# Original presentation plot'.
presentation_tobacco_plot1 <- 
  data_tob_per_year_format %>%
  group_by(cat_tob_usage_per_year, Year) %>%
  summarise(NY.GDP.PCAP.PP.KD = mean(NY.GDP.PCAP.PP.KD, na.rm = TRUE)) %>% 
  ggplot(aes(x = cat_tob_usage_per_year, y = NY.GDP.PCAP.PP.KD)) +
  geom_col() +
  facet_wrap( ~ Year, ncol = 4) +
  theme_bw() +
  labs(
    x = "relativer Tabakkonsum",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum vs. BIP - mit jährlich gruppierten Daten"
  ) +
  theme(axis.text = element_text(size = 15),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        plot.title = element_text(hjust = 0.5, size = 20),
        strip.text = element_text(size = 16))

# Note: The following plot is the updated version of the presentation plot created in the
# plotting code above and used during presentation held on 2025/01/20. The older version
# is not shown in the R markdown file anymore, only this feedback-adjusted version. For
# reproducibility purposes though, the original plot remains in the code, so the original
# presentation can still be rendered even after the feedback has been implemented. Moving
# forward, we will only mark the adjusted version with '# Updated presentation plot'.

pres_updated_tobacco_plot1 <-
  presentation_tobacco_plot1 +
  labs(
    x = "relativer Tabakkonsum",
    y = "BIP pro Kopf [$]",
    title = "Tabakkonsum und BIP - jährlich gruppierte Daten"
  )
```
<br> For the years 2000, 2005 and 2010, countries with very low and high average tobacco use had a higher GDP per capita in the dataset. <br> This changes in 2015, 2018, 2019 and 2020. It is striking that countries with relatively very low tobacco use now had the lowest GDP per capita of all the countries listed. <br> For all other categories of relative tobacco use it seems, that countries with relatively high tobacco use show a lower GDP per capita. <br> <br>

In the following, we want to investigate the relationship further by taking a step back and looking at the data without the yearly grouping. This is now done by starting with the initial comparison of the two variables without taking the time of data acquisition into account.

#### 1.2. Scatter plot of interested variables

```{r scatter_with_outlier_tob, echo=FALSE, fig.height=8, fig.width=14, message=FALSE, warning=FALSE}
# Scatter plot of interested variables
scatter_tob_gdp <-
  ggplot(data_tobacco, aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD)) +
  geom_point(alpha = 0.5, size = 3.5) +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "BIP pro Kopf [$]",
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000),
                     minor_breaks = waiver(),
                     limits = c(0, 125000)) +
  scale_color_manual(name = "",
                     values = c("Robust-Linear" = brewer.pal(3, "Set2")[[2]],
                                "Linear" = brewer.pal(3, "Set2")[[3]])) +
  theme_bw() +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 16),
        axis.title.y = element_text(margin = margin(r = 10), size = 16),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        plot.title = element_text(hjust = 0.5, size = 20))

# Original presentation plot
presentation_tobacco_backup1 <-
  scatter_tob_gdp +
  ggtitle("Prävalenz des Tabakkonsums vs. BIP pro Kopf") +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, color = "Robust-Linear"),
              method = MASS::rlm, linewidth = 1.5, se = FALSE) +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, color = "Linear"),
              method = "lm", linewidth = 1.5, se = FALSE)

# Updated presentation plot
pres_updated_tobacco_backup1 <-
  scatter_tob_gdp +
  ggtitle("Prävalenz des Tabakkonsums und BIP pro Kopf") +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD,
                  color = "Robust-Linear", fill = "Robust-Linear"),
              method = MASS::rlm, linewidth = 1.5, se = TRUE, alpha = 0.3) +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD,
                  color = "Linear", fill = "Linear"),
              method = "lm", linewidth = 1.5, se = TRUE, alpha = 0.3) +
  scale_fill_manual(name = "", values = c("Robust-Linear" = brewer.pal(3, "Set2")[[2]],
                                          "Linear" = brewer.pal(3, "Set2")[[3]]))

pres_updated_tobacco_backup1
```

We observe a slight positive relationship while the direction of this relationship seems to be heavily influenced by the high GDP per capita and low tobacco prevalence outliers in the upper left hand area of the plot according to the different regression models used.
<br><br>
As we are looking at the data without any consideration of time, we want to check whether those data points all belong to the same country and, if that is actually the case, what the relationship would look like without this one-country-bias.

#### 1.3. Scatter plot of interested variables; except outlier Qatar

```{r scatter_without_outlier_tob, echo=FALSE, fig.height=8, fig.width=14, message=FALSE, warning=FALSE}
# Investigate the y-axis outlier - are they all from the same country?
data_tobacco %>% filter(NY.GDP.PCAP.PP.KD > 80000)
# Indeed, all the data points originate out of Qatar

# Scatter plot of interested variables; except outlier Qatar
scatter_tob_gdp_without_Qatar <-
  ggplot(data_tobacco[data_tobacco$`Country Code` != "QAT", ],
       aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD)) +
  geom_point(alpha = 0.5, size = 3.5) +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "BIP pro Kopf [$]",
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000),
                     minor_breaks = waiver(),
                     limits = c(0, 125000)) +
  scale_color_manual(name = "",
                     values = c("Robust-Linear" = brewer.pal(3, "Set2")[[2]],
                                "Linear" = brewer.pal(3, "Set2")[[3]])) +
  theme_bw() +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 16),
        axis.title.y = element_text(margin = margin(r = 10), size = 16),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        plot.title = element_text(hjust = 0.5, size = 20))

# Original presentation plot
presentation_tobacco_backup2 <-
  scatter_tob_gdp_without_Qatar +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, color = "Robust-Linear"),
              method = MASS::rlm, linewidth = 1.5, se = FALSE) +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, color = "Linear"),
              method = "lm", linewidth = 1.5, se = FALSE) +
  ggtitle("Prävalenz des Tabakkonsums vs. BIP pro Kopf - ohne Ausreißer")

# Updated presentation plot
pres_updated_tobacco_backup2 <-
  scatter_tob_gdp_without_Qatar +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD,
                  color = "Robust-Linear", fill = "Robust-Linear"),
              method = MASS::rlm, linewidth = 1.5, se = TRUE, alpha = 0.3) +
  geom_smooth(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD,
                  color = "Linear", fill = "Linear"),
              method = "lm", linewidth = 1.5, se = TRUE, alpha = 0.3) +
  ggtitle("Prävalenz des Tabakkonsums und BIP pro Kopf - ohne Ausreißer") +
  scale_fill_manual(name = "", values = c("Robust-Linear" = brewer.pal(3, "Set2")[[2]],
                                          "Linear" = brewer.pal(3, "Set2")[[3]]))

pres_updated_tobacco_backup2
```

The removal of the Qatari data points leads us to slightly positive relationships for both, the linear as well as the robust-linear regression, visualized by the basically parallel straights divided only by marginal vertical differences.
<br><br>
Keeping this influence of the outliers in mind, we want to do the small intermediate step to check which of the linear relationship is actually represented in each of the observable years and introduce another form of regression to get deeper understanding of how much the robust-linear representation is appropriate.

#### 1.4. Scatter plot of interested variables with faceted years

```{r scatter_faceted_tob, fig.height=7, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}
# Scatter plot of interested variables with faceted years
scatter_faceted_tob_gdp <-
  ggplot(data_tobacco, aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD)) +
  geom_point(alpha = 0.5) +
  geom_smooth(data = data_tobacco,
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year,
                  color = "Robust-Linear", fill = "Robust-Linear"),
              method = MASS::rlm, linewidth = 1, se = TRUE, alpha = 0.3) +
  geom_smooth(data = data_tobacco,
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year,
                  color = "Linear", fill = "Linear"),
              method = "lm", linewidth = 1, se = TRUE, alpha = 0.3) +
  ggtitle("Prävalenz des aktuellen Tabakkonsums und BIP pro Kopf") +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "BIP pro Kopf [$]",
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000),
                     minor_breaks = waiver(),
                     limits = c(0, 125000)) +
  scale_color_manual(name = "",
                     values = c("Linear" = brewer.pal(3, "Set2")[[3]],
                                "Robust-Linear" = brewer.pal(3, "Set2")[[2]])) +
  scale_fill_manual(name = "", values = c("Linear" = brewer.pal(3, "Set2")[[3]],
                                          "Robust-Linear" = brewer.pal(3, "Set2")[[2]])) +
  theme_bw() +
  theme(axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ Year, ncol = 4)
scatter_faceted_tob_gdp
```

It seems that the Qatari data point in each of the years is still highly influential on the linear relationship. However, the relationship develops to more synchronized behaviour between the robust and non-robust relationship, with the non-robust changing from slightly negative to slightly positive.
<br><br>
But looking at the distribution of the data points within each facet, something very interesting is happening. With the higher density of points in the horizontal middle of the cloud and the simultaneous deviation of some of those points in the higher GDP direction, we can recognize a presumably new relationship we want to visualize next.

#### 1.5. Scatter plot of interested variables with faceted years with density curves

```{r scatter_faceted_density_tob, fig.height=7, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}
# Prepare the density visualization:
# Calculate mean and standard deviation for each year
data_tobacco_param <- data_tobacco %>%
  group_by(Year) %>%
  summarize(SH.PRV.SMOK_mean = mean(SH.PRV.SMOK),
            SH.PRV.SMOK_sd = sd(SH.PRV.SMOK)) %>%
  ungroup()

# Generate evenly-spaced values of x and compute density for each year
data_tobacco_normdensity <- data_tobacco_param %>%
  rowwise() %>%
  mutate(
    # Create 100 evenly-spaced points in-between the lowest and highest possible x value
    norm_x_val = list(seq(0, 100, length.out = 101)),
    # Compute the corresponding PDF values
    norm_y_val = list(dnorm(norm_x_val,
                            mean = SH.PRV.SMOK_mean,
                            sd = SH.PRV.SMOK_sd))) %>%
  # Convert the lists into columns
  unnest(c(norm_x_val, norm_y_val))

# Remove rows with values of calculated normal distribution that are larger than 60%
# (i.e. 60% > max(SH.PRV.SMOK))
data_tobacco_normdensity <- data_tobacco_normdensity %>%
  filter(norm_x_val <= 60)


# Scatter plot of interested variables faceted years with density curves
# Plot the upper row of the data points for the assembled tobacco plotting
scatter_faceted_tob_gdp_data_upper <- 
  ggplot(data_tobacco %>% filter(Year %in% c(2000, 2005, 2010, 2015))) +
  geom_point(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
             alpha = 0.5, size = 2.5) +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "BIP pro Kopf [$]",
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000),
                     minor_breaks = waiver(),
                     limits = c(0, 125000)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 14),
        plot.margin = margin(0, 0, 0, 0),
        plot.title = element_text(hjust = 0.5, size = 18),
        strip.text = element_text(size = 12)) +
  facet_wrap(~ Year, ncol = 4)

# Original presentation plot - upper row of scatter plots
plot_tobacco1_data_upper <-
  scatter_faceted_tob_gdp_data_upper +
  geom_smooth(data = data_tobacco %>% filter(Year %in% c(2000, 2005, 2010, 2015)),
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
              method = MASS::rlm, linewidth = 1, se = FALSE, color = "black") +
  ggtitle("Prävalenz des Tabakkonsums vs. BIP pro Kopf")

# Updated presentation plot - upper row of scatter plots
updated_plot_tobacco1_data_upper <-
  scatter_faceted_tob_gdp_data_upper +
  geom_smooth(data = data_tobacco %>% filter(Year %in% c(2000, 2005, 2010, 2015)),
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
              method = MASS::rlm, linewidth = 1, se = TRUE, color = "black", alpha = .3) +
  ggtitle("Prävalenz des Tabakkonsums und BIP pro Kopf")

# Plot the bottom row of the data points for the assembled tobacco plotting
scatter_faceted_tob_gdp_data_bottom <-
  ggplot(data_tobacco %>% filter(Year %in% c(2018, 2019, 2020))) +
  geom_point(aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
             alpha = 0.5, size = 2.5) +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "BIP pro Kopf [$]",
                     breaks = c(0, 25000, 50000, 75000, 100000, 125000),
                     minor_breaks = waiver(),
                     limits = c(0, 125000)) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 12),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 14),
        legend.position = "bottom", 
        plot.margin = margin(0, 0, 0, 0),
        strip.text = element_text(size = 12)) +
  facet_wrap(~ Year)

# Original presentation plot - bottom row of scatter plots
plot_tobacco1_data_bottom <-
  scatter_faceted_tob_gdp_data_bottom +
  geom_smooth(data = data_tobacco %>% filter(Year %in% c(2018, 2019, 2020)),
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
              method = MASS::rlm, linewidth = 1, se = FALSE, color = "black")

# Updated presentation plot - bottom row of scatter plots
updated_plot_tobacco1_data_bottom <-
  scatter_faceted_tob_gdp_data_bottom +
  geom_smooth(data = data_tobacco %>% filter(Year %in% c(2018, 2019, 2020)),
              aes(x = SH.PRV.SMOK, y = NY.GDP.PCAP.PP.KD, group = Year),
              method = MASS::rlm, linewidth = 1, se = TRUE, color = "black", alpha = .3)

# Add overlayed normal distribution curves to the assembled plot in the data displays
# Plot the upper row of the density curves for the assembled tobacco plotting
plot_tobacco1_density_upper <-
  ggplot() +
  geom_line(data = data_tobacco_normdensity %>%
              filter(Year %in% c(2000, 2005, 2010, 2015)),
            aes(x = norm_x_val, y = norm_y_val, group = Year),
            color = brewer.pal(4, "Set2")[[3]], linewidth = 1, inherit.aes = FALSE) +
  geom_density(data = data_tobacco %>%
                 filter(Year %in% c(2000, 2005, 2010, 2015)),
               aes(x = SH.PRV.SMOK, y = after_stat(density), group = Year),
               color = brewer.pal(4, "Set2")[[2]], linewidth = 1, bw = 3) +
  geom_vline(data = data_tobacco_normdensity %>%
               filter(Year %in% c(2000, 2005, 2010, 2015)),
             aes(xintercept = SH.PRV.SMOK_mean, group = Year),
             color = "black", linetype = "dashed") +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "Dichte",
                     breaks = c(0, 0.025, 0.05),
                     minor_breaks = waiver(),
                     limits = c(0, 0.06)) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin = margin(r = 10), size = 14),
        plot.margin = margin(0, 0, 0, 0),
        strip.text = element_blank()) +
  facet_wrap(~ Year, ncol = 4)

# Plot the bottom row of the density curves for the assembled tobacco plotting
plot_tobacco1_density_bottom <-
  ggplot() +
  geom_line(data = data_tobacco_normdensity %>% filter(Year %in% c(2018, 2019, 2020)),
            aes(x = norm_x_val, y = norm_y_val, group = Year, color = "Normalverteilung"),
            linewidth = 1, inherit.aes = FALSE) +
  geom_density(data = data_tobacco %>% filter(Year %in% c(2018, 2019, 2020)),
               aes(x = SH.PRV.SMOK, y = after_stat(density), group = Year),
               color = brewer.pal(3, "Set2")[[2]], linewidth = 1, bw = 3,
               show.legend = FALSE) +
  # Add an invisible line by framing dummy line to show 'Kerndichteschaetzer' with line
  # shape instead of hollow square in legend
  geom_line(data = data.frame(x = c(0,0), y = c(0,0)),
            aes(x = x, y = y, color = "Kerndichteschätzer (Bandbreite = 3)"),
            linewidth = 1) +
  # Add an invisible line by framing dummy line to show 'Robust-Linear' with line
  # shape in the single legend below the whole assembled plot
  geom_line(data = data.frame(x = c(0,0), y = c(0,0)),
            aes(x = x, y = y, color = "Robust-Linearer Zusammenhang"),
            linewidth = 1) +
  geom_vline(data = data_tobacco_normdensity %>% filter(Year %in% c(2018, 2019, 2020)),
             aes(xintercept = SH.PRV.SMOK_mean, group = Year),
             color = "black", linetype = "dashed") +
  scale_x_continuous(name = "Prävalenz des aktuellen Tabakkonsums [%]",
                     breaks = c(0, 10, 20, 30, 40, 50, 60),
                     minor_breaks = waiver(),
                     limits = c(0, 60)) +
  scale_y_continuous(name = "Dichte",
                     breaks = c(0, 0.025, 0.05),
                     minor_breaks = waiver(),
                     limits = c(0, 0.06)) +
  scale_color_manual(
    name = "",
    values = c("Kerndichteschätzer (Bandbreite = 3)" = brewer.pal(3, "Set2")[[2]],
               "Normalverteilung" = brewer.pal(3, "Set2")[[3]],
               "Robust-Linearer Zusammenhang" = "black")) +
  theme_bw() +
  theme(axis.text = element_text(size = 12),
        axis.title.x = element_text(hjust = 0.85, margin = margin(t = 10), size = 14),
        axis.title.y = element_text(margin = margin(r = 10), size = 14),
        legend.position = c(0.667, -1.75),
        legend.direction = "horizontal",
        legend.text = element_text(size = 14),
        plot.margin = margin(0, 0, 0, 0),
        strip.text = element_blank()) +
  facet_wrap(~ Year)

# Original presentation plot - assemble the plot
presentation_tobacco_plot2 <-
  (plot_tobacco1_data_upper /
    plot_tobacco1_density_upper /
    plot_spacer() /
    (plot_tobacco1_data_bottom + plot_spacer() + plot_layout(widths = c(3, 1))) /
    (plot_tobacco1_density_bottom + plot_spacer() + plot_layout(widths = c(3, 1))) +
    plot_layout(heights = c(1.9, 0.4, 0.1, 1.9, 0.4, 0.3), widths = c(1, 1, 1, 1))) &
  theme(plot.margin = margin(0, 0, 0, 0))

# Updated presentation plot - assemble the plot
pres_updated_tobacco_plot2 <-
  (updated_plot_tobacco1_data_upper /
    plot_tobacco1_density_upper /
    plot_spacer() /
    (updated_plot_tobacco1_data_bottom + plot_spacer() + plot_layout(widths = c(3, 1))) /
    (plot_tobacco1_density_bottom + plot_spacer() + plot_layout(widths = c(3, 1))) +
    plot_layout(heights = c(1.9, 0.4, 0.1, 1.9, 0.4, 0.3), widths = c(1, 1, 1, 1))) &
  theme(plot.margin = margin(0, 0, 0, 0))

pres_updated_tobacco_plot2
```

We recognize the basically neutral relation in the year 2000 changing over time. Each year the trend gains slight positive increase, meaning over time, it changes towards the relationship of the more the country's GDP per capita, the higher its prevalence of tobacco use among adults. Further, it gets obvious that the general distribution of the data points moves to the left on the x-axis, so generally smaller occurrences of tobacco prevalence as time goes by. The same phenomenon can be observed when looking at the dashed vertical line in the density visualization below the scatter plots, as the mean decreases from each observed year to the next. Having said that, we recognize slightly contrary movement on the y-axis, meaning higher GDP per capita for some of the countries, especially the points in the middle of the facets increase in GDP per capita. 
<br>
Moreover, the kernel density estimation seems to assimilate towards the normal distribution around the observed datas' means and standard deviations comparing the start and end of the timeframe.

#### 1.6. Kullback-Leibler divergence for tobacco usage

This can be proven by calculating the Kullback-Leibler divergence for each of the years, comparing the KDE with the underlying normal distribution to check the accuracy of describing our empirical distribution by normal distribution.

```{r kl_divergence_tob, echo=FALSE, fig.height=8, fig.width=14, message=FALSE, warning=FALSE}
# Compute Kullback-Leibler divergences for each year with differing kernel bandwidths
data_tobacco_kld <-
  kl_div_from_dnorm(data_tobacco, "SH.PRV.SMOK", kernel_bw = 2) %>%
  left_join(kl_div_from_dnorm(data_tobacco, "SH.PRV.SMOK", kernel_bw = 3)) %>%
  left_join(kl_div_from_dnorm(data_tobacco, "SH.PRV.SMOK", kernel_bw = 4)) %>%
  left_join(kl_div_from_dnorm(data_tobacco, "SH.PRV.SMOK", kernel_bw = 5))

colnames(data_tobacco_kld) <- gsub(pattern = "BW = ",
                                   replacement = "Breite = ",
                                   colnames(data_tobacco_kld),
                                   ignore.case = FALSE)
data_tobacco_kld <- data_tobacco_kld %>% rename("Jahr" = Year)

# Return table of Kullback-Leibler divergences for each year and each of the bandwidths
presentation_tobacco_backup3 <- kable(data_tobacco_kld)
presentation_tobacco_backup3

# Convert the kable table into a graphical object to safe it with ggsave
table_kldivergence <- tableGrob(data_tobacco_kld)
```

As we can see, there are clear differences between 2000 and 2020, regardless of granularity determined by the chosen bandwidth. Compared to the start of the time span, the empirical  distribution clearly attunes closer to the normal distribution at the end. However, the closest for each of the bandwidths is always 2010. For the bandwidth of two it is the only one which decreases from 2015 onwards again till the end. The wider bandwidths on the other hand, which smooth out the individual data points more with the risk of over-smoothing, decrease only for the first three facets and then increase again, all be it with marginal differences from 2018 to 2020.
<br><br>
In summary though and after a clear convergence in the early 2000s, the convergence towards a normally distributed prevalence of tobacco usage among adults stagnated slightly over the last years tending to a backwards development but not strong enough to make any assumptions for future developments. Still, with the general average consumption decreasing.

```{r tobacco_save_pngs, error=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Save all the graphics used during this markdown analysis to list of lists where each
# list contains the individual parameters for ggsave
pngs <- list(
  list(file = "dotplot_2020_tob_gdp.png", plot = tob_gdp_2020,
       height = 5, width = 8),
  list(file = "dotplot_facetyear_grouped_tob_gdp.png", plot = tob_gdp_facetyear_grouped,
       height = 5, width = 8),
  list(file = "dotplot_facetyear_yearlygrouped_tob_gdp.png",
       plot = tob_gdp_facetyear_yearlygrouped,
       height = 6, width = 10),
  list(file = "barplot_yearlygrouped_tob_gdp.png", plot = tob_gdp_barplot_yearlygrouped,
       height = 5, width = 8),
  list(file = "boxplot_yearlygrouped_tob_gdp.png", plot = tob_gdp_boxplot_yearlygrouped,
       height = 5, width = 8),
  list(file = "barplot_facetyear_yearlygrouped_tob_gdp.png", 
       plot = presentation_tobacco_plot1, height = 8, width = 15),
  list(file = "barplot_facetyear_yearlygrouped_tob_gdp_updated.png", 
       plot = pres_updated_tobacco_plot1, height = 8, width = 15),
  list(file = "scatter_tob_gdp.png", plot = presentation_tobacco_backup1,
       height = 8, width = 14),
  list(file = "scatter_tob_gdp_updated.png", plot = pres_updated_tobacco_backup1,
       height = 8, width = 14),
  list(file = "scatter_without_outlier_tob_gdp.png",
       plot = presentation_tobacco_backup2, height = 8, width = 14),
  list(file = "scatter_without_outlier_tob_gdp_updated.png",
       plot = pres_updated_tobacco_backup2, height = 8, width = 14),
  list(file = "scatter_faceted_tob_gdp.png", plot = scatter_faceted_tob_gdp,
       height = 7, width = 12),
  list(file = "scatter_density_tob_gdp.png", plot = presentation_tobacco_plot2,
       height = 7, width = 12),
  list(file = "scatter_density_tob_gdp_updated.png", plot = pres_updated_tobacco_plot2,
       height = 7, width = 12),
  list(file = "table_kldivergence.png", plot = table_kldivergence,
       height = 10, width = 16)
)

# Use lapply to apply ggsave to each element in the list
lapply(pngs, function(x) {
  ggsave(filename = x$file, plot = x$plot, path = here("Results", "Tobacco"),
         height = x$height, width = x$width, device = "png", dpi = 320, bg = "white")
})
```