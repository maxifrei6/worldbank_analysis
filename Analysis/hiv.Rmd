---
title: "Worldbank HIV Analysis"
author: "Leonie Mertes"
date: "2025-01-20"
output:
  html_document: default
---

## Introduction
This analysis explores relationships of HIV prevalence in the population aged 15-49 to the total alcohol consumption per capita as well as its coherence to the percentage of labor force with basic education. Therefore, we have two main parts:
<br>

######## 1. How does the HIV prevalence in the population aged 15-49 relate to the total alcohol consumption per capita?

######## 2. Do countries with a higher percentage of labor force with basic education have lower HIV prevalence rates in the 15-49 population?
<br>
```{r hiv_setup, message = FALSE, echo = FALSE, warning = FALSE}
# Load necessary libraries
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)

source(here("Scripts", "functions.R"))

# Load the dataset
data_merged <- readRDS(here("Data", "Processed", "data_merged.RDS"))
data_grouped <- readRDS(here("Data", "Processed", "data_grouped.RDS"))
data_processed <- left_join(data_merged, data_grouped,
                            by = c("Country Name", "Country Code"))
data_hiv <- data_processed %>%
  select(
    `Country Name`,
    `Country Code`,
    Year,
    SH.DYN.AIDS.ZS,
    SH.ALC.PCAP.LI,
    SL.TLF.BASC.ZS,
    cat_alc,
    cat_education
  )

## HIV Variable:  Prevalence of HIV, total (% of population ages 15-49)
#                 SH.DYN.AIDS.ZS

#                 Total alcohol consumption per capita
#                 (liters of pure alcohol, projected estimates, 15+ years of age)
#                 SH.ALC.PCAP.LI

#                 Labor force with basic education
#                 (% of total working-age population with basic education)
#                 SL.TLF.BASC.ZS
```

#### Data
The dataset we've been provided is longitudinal: 
<br>
- 25 countries
<br>
- 18 indicators
<br>
- yearly observations from 2000 to 2021
<br>
<br>

#### Terminology and Methodological Approach
To mitigate issues with data quality and variance in data, we employ statistical techniques, which you can read about in:
<br>
worldbank_analysis/Analysis/education.html
<br>
<br>

#### NA`s
First we check how many NA's are in the HIV, alcohol and education variables each Year (excluding years existing only of NA's). For a glimpse:
<br>
```{r hiv_1, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_table <- data_hiv %>%
  group_by(Year) %>%
  reframe(
    num_na_hiv = sum(is.na(SH.DYN.AIDS.ZS)),
    num_na_alc = sum(is.na(SH.ALC.PCAP.LI)),
    num_na_edu = sum(is.na(SL.TLF.BASC.ZS))
  ) %>%
  filter(num_na_hiv < 25 & num_na_alc < 25 & num_na_edu < 25)
print(data_table)
```
<br> 
It is noticeable that there does not seem to be any data for Aruba at all, so this country will be removed from the data set that we need for this analysis. Additionally, there is no data for alcohol consumption in 2021.
<br>
<br>
```{r hiv_2, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv <- data_hiv %>%
  filter(`Country Name` != "Aruba")
data_alc <- data_hiv %>%
  filter(Year %in% data_table$Year)
```

#### Grouping of the countries
The data is grouped by the variables we want to observe. To do this, we grouped the countries by the quantiles of the average values of the corresponding variable. In the following, the countries were devided into five categories. 
<br>
Since it is not always helpful to group over the average, an annual grouping is also used in the course of the script. Here, each country was categorized by quantiles over the corresponding variable each year.
<br>
<br>

### 1. HIV Prevalence and alcohol consumption
<br>
First we want to look at the existing data about the relevant variables. For getting an better feeling for the coherence of our variables, we plot a linear smooth line. Noticing the outliers, we also plot a linear smooth line not taking these extreme values into account to see, if the same coherence still exists.
<br>
<br>
```{r hiv_3, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc_without_outlier <- data_alc %>% 
  filter(`Country Name` != "Tansania")

# Note: The following plot is the original version of the presentation plot and used
# during the presentation held on 2025/01/20. For repoducibility purposes, the original
# plot remains in the code, for the feedback-adjusted version, refer to next code chunk.

presentation_hiv_plot1 <- data_alc %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.5) +
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = FALSE,
    size = 1.4
  ) +
  geom_smooth(
    data = data_alc_without_outlier,
    aes(colour = "Linear ohne Ausreißer"),
    method = "lm",
    se = FALSE,
    size = 1.4
  ) +
  scale_color_manual(
    name = "",
    values = c(
      "Linear" = brewer.pal(3, "Set2")[[2]],
      "Linear ohne Ausreißer" = brewer.pal(3, "Set2")[[3]]
    )
  ) +
  labs(x = "Alkoholkonsum pro Kopf [l]", y = "HIV Prävalenz [%]",
       title = "Alkoholkonsum vs. HIV") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.position = "bottom",
    legend.text = element_text(size = 14)
  )

presentation_hiv_backup1 <- data_alc %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.5) +
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = FALSE,
    size = 1.4
  ) +
  geom_smooth(
    aes(group = 1, colour = "robust-Linear"),
    method = MASS::rlm,
    se = FALSE,
    size = 1.4
  ) +
  scale_color_manual(
    name = "",
    values = c(
      "Linear" = brewer.pal(3, "Set2")[[2]],
      "robust-Linear" = brewer.pal(3, "Set2")[[3]]
    )
  ) +
  labs(x = "Alkoholkonsum pro Kopf [l]", 
       y = "HIV Prävalenz [%]", 
       title = "Alkoholkonsum vs. HIV") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.position = "bottom",
    legend.text = element_text(size = 14)
  )
```

```{r hiv_4, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Note: The following plot is the updated version of the presentation plot created in the
# code chunk above. In the R markdown file is only shown this feedback-adjusted version.

pres_updated_hiv_plot1 <- data_alc %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.4) +
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[2]],
    alpha = 0.3
  ) +
  geom_smooth(
    data = data_alc_without_outlier,
    aes(colour = "Linear ohne Ausreißer"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[3]],
    alpha = 0.35
  ) +
  scale_color_manual(
    name = "",
    values = c(
      "Linear" = brewer.pal(3, "Set2")[[2]],
      "Linear ohne Ausreißer" = brewer.pal(3, "Set2")[[3]]
    )
  ) +
  labs(x = "Alkoholkonsum pro Kopf [l]", 
       y = "HIV Prävalenz [%]", 
       title = "Alkoholkonsum und HIV") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.position = "bottom",
    legend.text = element_text(size = 14)
  )

presentation_hiv_backup1_update <- data_alc %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.4) +
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[2]],
    alpha = 0.3
  ) +
  geom_smooth(
    aes(group = 1, colour = "robust-Linear"),
    method = MASS::rlm,
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[3]],
    alpha = 0.35
  ) +
  scale_color_manual(name = "",
                     values = c("Linear" = brewer.pal(3, "Set2")[[2]],
                                "robust-Linear" = brewer.pal(3, "Set2")[[3]])) +
  labs(x = "Alkoholkonsum pro Kopf [l]", 
       y = "HIV Prävalenz [%]", 
       title = "Alkoholkonsum und HIV") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.position = "bottom",
    legend.text = element_text(size = 14)
  )

# plot for R Markdown
data_alc %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3, alpha = 0.4) +
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[2]],
    alpha = 0.3
  ) +
  geom_smooth(
    data = data_alc_without_outlier,
    aes(colour = "Linear ohne Ausreißer"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[3]],
    alpha = 0.35
  ) +
  scale_color_manual(name = "",
                     values = c("Linear" = brewer.pal(3, "Set2")[[2]],
                                "Linear ohne Ausreißer" = brewer.pal(3, "Set2")[[3]])) +
  labs(x = "Alkoholkonsum pro Kopf [l]", 
       y = "HIV Prävalenz [%]", 
       title = "Alkoholkonsum und HIV") +
  theme_bw() +
  theme(legend.position = "bottom")
```
<br>
Here we can see a slightly positive trend in the linear regression line. Excluding the outliers shows no coherence. We will go deeper into this observation later.
<br>
First, we plot the grouping of our data by alcohol consumption of the most recent data in Year 2020 to get familiar with our data set and categorization.
<br>
<br>
```{r hiv_5, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
country_alc_grouping <- data_alc %>%
  filter(Year == 2020) %>%
  ggplot(aes(`Country Name`, SH.ALC.PCAP.LI)) +
  geom_point(aes(fill = cat_alc),
             size = 3,
             alpha = 0.7,
             shape = 21) +
  scale_fill_viridis_d(name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1) +
  labs(y = "Alkoholkonsum pro Kopf [l]", 
       x = "Land", 
       title = "Allgemeine Gruppierung der Daten im Jahr 2020") +
  theme_bw() +
  theme(axis.text.x = element_text(
    angle = 20,
    hjust = 1,
    size = 5
  ),
  legend.position = "bottom")

country_alc_grouping
```
<br>
We can see some overlapping of the different groups, which could arise from grouping the data over averages of all years. As can be seen here, the grouping is not correct, especially for the low and medium category. The alcohol variable seems to vary over the years in such a way that an annual grouping makes sense. We will address this later in this script.
<br>
Now we take a look at the comparison of alcohol consumption and HIV prevalence in 2020. To take the grouping into account we group by the relative alcohol consumption. 
<br>
As you can see in the following, the outlier of the country Tanzania takes a great impact on our linear smooth line. Therefore the country Tanzania is removed for our second linear smooth line. (only for interest, how relations are moved)
<br>
<br>
```{r hiv_6, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# dataset without outlier adjusted range for correct presentation of data
data_alc_without_outlier <- data_alc %>% 
  filter(`Country Name` != "Tansania") %>% 
  filter(SH.ALC.PCAP.LI <= 12)

alc_hiv_2020 <- data_alc %>%
  filter(Year == 2020) %>%
  group_by(cat_alc) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  coord_cartesian(xlim = c(0, 12), ylim = c(0, 5)) +
  theme_bw() +
  labs(
    x = "Alkoholkonsum pro Kopf [l]",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum und HIV Prävalenz im Jahr 2020 - Allgemeine Gruppierung",
    colour = "relativer Alkoholkonsum"
  ) + 
  geom_smooth(
    aes(group = 1, colour = "Linear"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[2]],
    alpha = 0.25
  ) +
  geom_smooth(
    data = data_alc_without_outlier,
    aes(colour = "Linear ohne Ausreißer"),
    method = "lm",
    se = TRUE,
    size = 1.4,
    fill = brewer.pal(3, "Set2")[[3]],
    alpha = 0.35
  ) +
  scale_color_manual(
    name = "",
    values = c("Linear" = brewer.pal(3, "Set2")[[2]],
    "Linear ohne Ausreißer" = brewer.pal(3, "Set2")[[3]])
    ) +
  theme(
    legend.position = "bottom"
  )

alc_hiv_2020
```
<br>
To get a better overview, we take a look at all years. This shows the development of the HIV Prevalence for each category and the overall relations of the groups to each other.
<br>
<br>
```{r hiv_7, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
year_hiv_grouped <- data_hiv %>%
  group_by(Year, cat_alc) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS)) +
  geom_point(aes(fill = cat_alc),
             size = 3,
             alpha = 0.7,
             shape = 21) +
  scale_fill_viridis_d(name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8)) +
  labs(
    title = "HIV Prävalenz über die Jahre - Allgemeine Gruppierung",
    x = "Jahr",
    y = "HIV Prävalenz [%]"
  ) +
  theme(legend.position = "bottom")

year_hiv_grouped
```
<br>
Now we take a look at the average of all years, where we categorize by relative alcohol consumption and compare to the mean of HIV Prevalence.
<br>
<br>
```{r hiv_8, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
alc_hiv_barplot <- data_hiv %>%
  group_by(cat_alc) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_alc, y = SH.DYN.AIDS.ZS)) +
  geom_col() +
  theme_bw() +
  labs(x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz [%]",
    title =
      "Alkoholkonsum und HIV Prävalenz im Schnitt über die Jahre - Allgemeine Gruppierung"
    )

alc_hiv_barplot
```
<br>
When plotting likewise while faceting over year, we can see that only very slight fluctuations in the distribution are recognizable here. The plots per year are very similar to the plot shown above. Remembering that the grouping of our data wasn`t correct for each year individually, we now come back to the idea of annual grouping.
```{r hiv_9, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Grouping by alcohol consumption values each year and saving this full dataset in
# data_hiv using function 2.2 group_data_year
data_alc_per_year <- data_alc %>%
  group_by(Year) %>%
  mutate(
    cat_alc_per_year =
      group_data_year(
        df = data_alc,
        grouping_by = "SH.ALC.PCAP.LI",
        year = Year,
        column_new = "alc_per_year",
        quantile_labels = c("Sehr gering", "Gering", "Mittel", "Groß", "Sehr groß")
      )$cat_alc_per_year
  )
```
<br>
As we can see here, the plotted data per year show the correct classification of the quantiles:
<br>
<br>
```{r hiv_10, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left", fig.height=7, fig.width=11}
# plot for presentation
presentation_hiv_backup2 <- data_alc_per_year %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_alc_per_year),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1) +
  facet_wrap(~ Year) +
  labs(x = "Alkoholkonsum pro Kopf [l]", y = "HIV Prävalenz [%]",
       title = "Jährliche Gruppierung der Daten") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 18),
    legend.position = "bottom",
    strip.text = element_text(size = 14)
  )

# plot for updated presentation
presentation_hiv_backup2_update <- data_alc_per_year %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_alc_per_year),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1) +
  facet_wrap(~ Year) +
  labs(x = "Alkoholkonsum pro Kopf [l]", y = "HIV Prävalenz [%]",
       title = "Jährliche Gruppierung der Daten") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 18),
    legend.position = "bottom",
    strip.text = element_text(size = 14)
  )

# plot for R markdown
data_alc_per_year %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_alc_per_year),
    size = 2,
    alpha = 0.6,
    shape = 21
  ) +
  scale_fill_viridis_d(name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1) +
  facet_wrap(~ Year) +
  labs(x = "Alkoholkonsum pro Kopf [l]", y = "HIV Prävalenz [%]",
       title = "Jährliche Gruppierung der Daten") +
  theme_bw() +
  theme(legend.position = "bottom")
```
<br>
When we plot only one point per category of the plot above and combine the facets into one plot, the data would result in the following.
<br>
We use a smooth line of the method "loess" with a span of 1.05, for emphasizing the relation.
<br>
<br>
```{r hiv_11, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
alc_hiv_mean_per_group_yearly <- data_alc_per_year %>%
  group_by(cat_alc_per_year, Year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_alc_per_year),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Alkoholkonsum",
                       option = "plasma",
                       direction = -1
    ) +
  geom_smooth(
    aes(group = 1),
    method = "loess",
    size = 0.8,
    span = 1.05,
    color = "black"
  ) +
  theme_bw() +
  labs(
    x = "Alkoholkonsum pro Kopf [l]",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum und HIV Prävalenz im Schnitt über die Gruppierung - Jährlich gruppierte Daten",
    colour = "relativer Alkoholkonsum"
  ) +
  theme(legend.position = "bottom")

alc_hiv_mean_per_group_yearly
```
<br>
However, in order to include the scattering of the values and to avoid distortion due to averaging, the same data is shown in a box plot:
<br>
<br>
```{r hiv_12, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc_cat_n <- data_alc_per_year %>%
  group_by(cat_alc_per_year) %>%
  summarise(n = n())

xlabels <-
  paste0(sort(unique(data_alc_per_year$cat_alc_per_year)), "\nn = ", data_alc_cat_n$n)

data_alc_per_year %>%
  ggplot(aes(cat_alc_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  theme_bw() +
  scale_x_discrete(labels = xlabels) +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum und HIV Prävalenz - Jährlich gruppierte Daten",
    colour = "relativer Alkoholkonsum"
  )

# plot for presentation
presentation_hiv_plot2 <- data_alc_per_year %>%
  ggplot(aes(cat_alc_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  theme_bw() + 
  scale_x_discrete(labels = xlabels) +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum vs. HIV Prävalenz - mit jährlich gruppierten Daten",
    colour = "relativer Alkoholkonsum"
  ) +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        plot.title = element_text(hjust = 0.5, size = 20))

# plot for updated presentation
pres_updated_hiv_plot2 <- data_alc_per_year %>%
  ggplot(aes(cat_alc_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  theme_bw() + 
  scale_x_discrete(labels = xlabels) +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum und HIV Prävalenz - mit jährlich gruppierten Daten",
    colour = "relativer Alkoholkonsum"
  ) +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        plot.title = element_text(hjust = 0.5, size = 20))
```
<br>
If we now look at the average bar plot again, but with annually regrouped data, it looks like this:
<br>
<br>
```{r hiv_13, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
alc_hiv_barplot_yearlygrouped <- data_alc_per_year %>%
  group_by(cat_alc_per_year) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_alc_per_year, y = SH.DYN.AIDS.ZS)) +
  geom_col() +
  theme_bw() +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz [%]",
    title = "Alkoholkonsum und HIV Prävalenz - Jährlich gruppierte Daten"
  )

alc_hiv_barplot_yearlygrouped
```
<br>
We really can see a big difference to our first bar plot with our general categorization.
<br>
When plotting the data including the alcohol consumption variable, we can see the actual improved grouping very clearly.
<br>
When plotting the same bar plot but faceted over all years, to avoid oversimplifying our data, we can see slight differences but every bar plot shows an similar coherence as the one above.
<br> 
<br>
**How does the HIV prevalence in the population aged 15-49 relate to the total alcohol consumption per capita?**
<br>
<br>
In general, it can be seen that countries with high alcohol consumption had a higher HIV prevalence on average over all years. It should be noted that this can only be seen on average. This statement can no longer be made when analyzing medians. In the median, as can be seen in the boxplot, countries with relatively low alcohol consumption have the highest HIV rate. It is also noticeable that countries with higher relative alcohol consumption have a much greater spread of HIV values, as the corresponding boxplot shows a much larger interquartile range (size of the box). They are therefore more likely to have extreme HIV rates, but they are not more likely to actually show higher values.
<br>
<br>
<br>

### 2. **HIV prevalence and basic education**
```{r hiv_14, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu <- data_hiv %>%
  filter(`Country Name` != "China") %>%
  filter(`Country Name` != "Kasachstan")
```
<br>
In the beginning we take a look at the most recent data, the year 2021. We want a first impression of correlation of percentage of the labor force with basic education and HIV prevalence. For that we plot a linear regression line. We can see the grouping of our data by colour to get a first impression about our grouping.
<br>
<br>
```{r hiv_15, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
edu_hiv_2021 <- data_edu %>%
  filter(Year == 2021) %>%
  group_by(cat_education) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_education),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Erwerbstätigen\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  coord_cartesian(ylim = c(0, 1.75)) +
  theme_bw() +
  labs(x = "Erwerbstätige mit grundlegender Bildung [%]", 
       y = "HIV Prävalenz [%]", 
       title = "Bildungsstand und HIV Prävalenz im Jahr 2021 - Allgemeine Gruppierung") +
  geom_smooth(
    aes(group = 1),
    method = "lm",
    se = TRUE,
    color = "black",
    alpha = 0.3,
    size = 0.8
  ) +
  theme(legend.position = "bottom")

edu_hiv_2021
```
In the plot above it stands out that there are no points for the medium category of our relative percentage of labor force with basic education. This implies that we have some missing data, especially of all countries being part of this "medium" group. This is caused by grouping over the average of all years of our education variable. This problem would be solved by grouping annually. 
<br>
It would also solve the problem of false categorization when looking at a specific Year like above. The countries of the groups "great" and "very great" aren`t correct categorized.
<br>
The smooth line shows a small positive coherence. Further analysis follows.
<br>
<br>
Here is a plot over all years to get an overview of the relationship between our groups and the development of HIV Prevalence observed in each category.
<br>
<br>
```{r hiv_16, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
year_hiv_grouped_edu <- data_edu %>%
  group_by(Year, cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_education),
    size = 3,
    alpha = 0.6,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Erwerbstätigen\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8), 
        legend.position = "bottom") +
  labs(title = "HIV Prävalenz über die Jahre", 
       x = "Jahr", 
       y = "HIV Prävalenz [%]")

year_hiv_grouped_edu
```
<br>
The 60 % of our countries with relative high education level also show a higher HIV Prevalence. Their Prevalence is falling over the years, while countries with lower education level have an small tendency to increasing HIV prevalence. The labor force with relative great percentage of educated labor force have a higher HIV Prevalence than the others.
<br>
Now we take a look at all years. While faceting by our categorization, we can observe the distribution of our HIV values in each group.
<br>
<br>
```{r hiv_17, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
year_hiv_facetedu <- data_edu %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS)) +
  geom_point(size = 2, alpha = 0.4) +
  facet_wrap(~ cat_education) +
  theme_bw() +
  labs(
    title = "HIV Prävalenz und Grundbildung",
    subtitle = "Je nach relativem Anteil an Erwerbstätigen mit grundlegender Bildung",
    x = "Jahr",
    y = "HIV Prävalenz [%]"
  )

year_hiv_facetedu
```
<br>
Here we can see especially in the group with a big percentage of labor force with basic education, that the scattering of our values mainly arises by differences of HIV values between countries being categorized into one group.
<br>
<br>
We want to create a plot of the averages over all years grouped by education level. First is displayed a bar plot and then a plot with the variable we grouped by on the x-axis for proof of an acceptable grouping.
<br>
<br>
```{r hiv_18, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
edu_hiv_barplot <- data_edu %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    .groups = "drop"
    ) %>%
  ggplot(aes(x = cat_education, y = SH.DYN.AIDS.ZS)) +
  geom_col() +
  theme_bw() +
  labs(x = "relativer Anteil an Erwerbstätigen mit grundlegender Bildung", 
       y = "HIV Prävalenz [%]", 
       title = "Gebildete Erwerbstätige und HIV Prävalenz im Schnitt über die Jahre")

edu_hiv_barplot
```
<br>
If we look at the bar plots faceted by year, we notice that the differences between the groups have decreased in amount.  HIV prevalence has fallen on average over the years, especially in countries with the highest HIV rates. However, the distribution itself is always similar to the plot shown above.
<br>
In the following we view the same plot but with the added education variable on the x-axis.
<br>
<br>
```{r hiv_19, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
edu_hiv_dotplot <- data_edu %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_education),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Erwerbstätigen\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  geom_smooth(
    aes(group = 1),
    method = "lm",
    se = TRUE,
    colour = "black",
    size = 0.7
  ) +
  coord_cartesian(ylim = c(0, 3)) +
  theme_bw() +
  labs(
    x = "Erwerbstätige mit grundlegender Bildung [%]",
    y = "HIV Prävalenz [%]",
    title = "Gebildete Erwerbstätige und HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Allgemeine Gruppierung"
  ) +
  theme(legend.position = "bottom")

edu_hiv_dotplot
```
<br>
Here we see that the grouping is not acceptable. For example, the group with a low proportion of educated workers has, on average, a higher proportion of educated workers than the group with a medium proportion of educated workers.
<br>
The confidence interval also shows that one can hardly make a statement here.
<br>
To solve these problems, we now address the annual grouping of our education variable:
<br>
```{r hiv_20, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Grouping by basic education values each year and saving this full dataset in
# data_edu_per year using function 2.2 group_data_year
data_edu_per_year <- data_edu %>%
  group_by(Year) %>%
  mutate(
    cat_edu_per_year =
      group_data_year(
        df = data_edu,
        grouping_by = "SL.TLF.BASC.ZS",
        year = Year,
        column_new = "edu_per_year",
        quantile_labels = c("Sehr gering", "Gering", "Mittel", "Groß", "Sehr groß")
      )$cat_edu_per_year
  )
# sehr viele NA values in neuer Spalte cat_edu_per_year
data_edu_per_year <- data_edu_per_year %>% 
  filter(!is.na(cat_edu_per_year))
```
If we look at the average plot, only that the data has been regrouped annually, we see that the new grouping is much better. (The averages are evenly distributed along the x axis.)
<br>
<br>
```{r hiv_21, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_edu_per_year),
    size = 3,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Erwerbstätigen\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  theme_bw() +
  labs(
    y = "HIV Prävalenz [%]",
    title = "Gebildete Erwerbstätige und HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Jährlich gruppiert",
    x = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme(legend.position = "bottom")
```

```{r hiv_22, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# plot for presentation
presentation_hiv_backup3 <- data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_edu_per_year),
    size = 8,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Arbeitenden\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  labs(y = "HIV Prävalenz [%]", 
       title = "Grundbildung vs. HIV Prävalenz mit jährlich gruppierten Daten", 
       x = "Erwerbstätige mit grundlegender Bildung [%]") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.position = "bottom"
  )

# plot for updated presentation
presentation_hiv_backup3_update <- data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(
    aes(fill = cat_edu_per_year),
    size = 8,
    alpha = 0.7,
    shape = 21
  ) +
  scale_fill_viridis_d(
    name = "relativer Anteil an Arbeitenden\nmit grundlegender Bildung",
    option = "plasma", direction = -1
    ) +
  labs(y = "HIV Prävalenz [%]", 
       title = "Grundbildung und HIV Prävalenz mit jährlich gruppierten Daten", 
       x = "Erwerbstätige mit grundlegender Bildung [%]") +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.position = "bottom"
  )
```
<br>
Here a plot with data pairs that are calculated over the average values of the group per year.
<br>
<br>
```{r hiv_23, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu_per_year %>%
  group_by(cat_edu_per_year, Year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3, alpha = 0.5) +
  theme_bw() +
  labs(x = "Erwerbstätige mit grundlegender Bildung [%]", 
       y = "HIV Prävalenz [%]", 
       title = "Grundbildung und HIV Prävalenz im Schnitt über die jährliche Gruppierung")


# plot for presentation

presentation_hiv_plot3 <- data_edu_per_year %>%
  group_by(cat_edu_per_year, Year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.5) +
  theme_bw() +
  labs(x = "Erwerbstätige mit grundlegender Bildung [%]", 
       y = "HIV Prävalenz [%]", 
       title =
         "Grundbildung vs. HIV Prävalenz - im Schnitt über die jährliche Gruppierung") +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20)
  )


# plot for updated presentation

pres_updated_hiv_plot3 <- data_edu_per_year %>%
  group_by(cat_edu_per_year, Year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS)) +
  geom_point(size = 3.5, alpha = 0.5) +
  theme_bw() +
  labs(x = "Erwerbstätige mit grundlegender Bildung [%]", 
       y = "HIV Prävalenz [%]", 
       title =
         "Grundbildung und HIV Prävalenz - im Schnitt über die jährliche Gruppierung") +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20)
  )
```
<br>
But is the data possibly skewed by the averaging calculation? 
Let’s take a look at the box plots for each category:
<br>
<br>
```{r hiv_24, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu_cat_n <- data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  summarise(n = n())

x_labels <-
  paste0(sort(unique(data_edu_per_year$cat_edu_per_year)), "\nn = ", data_edu_cat_n$n)

data_edu_per_year %>%
  ggplot(aes(cat_edu_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
  scale_x_discrete(labels = x_labels) +
  theme_bw() +
  labs(x = "relativer Anteil an Erwerbstätigen mit grundlegender Bildung", 
       y = "HIV Prävalenz [%] (log10)", 
       title = "Grundbildung und HIV Prävalenz - jährlich gruppierte Daten")


# plot for presentation

presentation_hiv_plot4 <- data_edu_per_year %>%
  ggplot(aes(cat_edu_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
  theme_bw() +
  scale_x_discrete(labels = x_labels) +
  labs(x = "relativer Anteil an Erwerbstätigen mit grundlegender Bildung", 
       y = "HIV Prävalenz [%] (Log10)", 
       title = "Grundbildung vs. HIV Prävalenz - mit jährlich gruppierten Daten") +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20)
  )

# plot for updated presentation

pres_updated_hiv_plot4 <- data_edu_per_year %>%
  ggplot(aes(cat_edu_per_year, SH.DYN.AIDS.ZS)) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
  theme_bw() +
  scale_x_discrete(labels = x_labels) +
  labs(x = "relativer Anteil an Erwerbstätigen mit grundlegender Bildung", 
       y = "HIV Prävalenz [%] (log10)", 
       title = "Grundbildung und HIV Prävalenz - jährlich gruppierte Daten") +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20)
  )
```
<br>
**Do countries with higher percentage of labor force with basic education have lower HIV prevalence rates in the 15-49 population?**
<br>
<br>
From the last few plots, it is obvious that a higher proportion of workers with basic education in a country is also associated with a higher HIV prevalence. So this question is negated in terms of the data.

```{r hiv_save_pngs, error=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Save all the graphics used during this markdown analysis to list of lists where each
# list contains the individual parameters for ggsave
pngs <- list(
  list(file = "dotplot_alc_hiv.png", plot = presentation_hiv_plot1,
       height = 8, width = 14),
  list(file = "dotplot_rlm_alc_hiv.png", plot = presentation_hiv_backup1,
       height = 8, width = 14),
  list(file = "dotplot_alc_hiv_updated.png", plot = pres_updated_hiv_plot1,
       height = 8, width = 14),
  list(file = "dotplot_rlm_alc_hiv_updated.png", plot = presentation_hiv_backup1_update,
       height = 8, width = 14),
  list(file = "dotplot_grouping_country_alc.png", plot = country_alc_grouping,
       height = 5, width = 8),
  list(file = "dotplot_2020_alc_hiv.png", plot = alc_hiv_2020,
       height = 5, width = 8),
  list(file = "dotplot_groupedalc_year_hiv.png", plot = year_hiv_grouped,
       height = 5, width = 8),
  list(file = "barplot_alc_hiv.png", plot = alc_hiv_barplot, 
       height = 5, width = 8),
  list(file = "dotplot_facetyear_yearlygrouped_alc_hiv.png", 
       plot = presentation_hiv_backup2, height = 8, width = 14),
  list(file = "dotplot_facetyear_yearlygrouped_alc_hiv_updated.png", 
       plot = presentation_hiv_backup2_update, height = 8, width = 14),
  list(file = "dotplot_mean_per_group_yearly_alc_hiv.png", 
       plot = alc_hiv_mean_per_group_yearly, height = 5, width = 8),
  list(file = "boxplot_yearlygrouped_alc_hiv.png",
       plot = presentation_hiv_plot2, height = 8, width = 14),
  list(file = "boxplot_yearlygrouped_alc_hiv_updated.png", 
       plot = pres_updated_hiv_plot2, height = 8, width = 14),
  list(file = "barplot_yearlygrouped_alc_hiv.png", 
       plot = alc_hiv_barplot_yearlygrouped, height = 5, width = 8),
  list(file = "dotplot_2021_grouping_edu_hiv.png",
       plot = edu_hiv_2021, height = 5, width = 8),
  list(file = "dotplot_groupededu_year_hiv.png",
       plot = year_hiv_grouped_edu, height = 5, width = 8),
  list(file = "dotplot_facetedu_year_hiv.png",
       plot = year_hiv_facetedu, height = 6, width = 9),
  list(file = "barplot_edu_hiv.png",
       plot = edu_hiv_barplot, height = 5, width = 8),
  list(file = "dotplot_edu_hiv.png",
       plot = edu_hiv_dotplot, height = 5, width = 8),
  list(file = "dotplot_yearlygrouped_edu_hiv.png",
       plot = presentation_hiv_backup3, height = 8, width = 14),
  list(file = "dotplot_yearlygrouped_edu_hiv_updated.png",
       plot = presentation_hiv_backup3_update, height = 8, width = 14),
  list(file = "dotplot_mean_per_group_yearly_edu_hiv.png",
       plot = presentation_hiv_plot3, height = 8, width = 14),
  list(file = "dotplot_mean_per_group_yearly_edu_hiv_updated.png",
       plot = pres_updated_hiv_plot3, height = 8, width = 14),
  list(file = "boxplot_edu_hiv.png",
       plot = presentation_hiv_plot4, height = 8, width = 14),
  list(file = "boxplot_edu_hiv_updated.png",
       plot = pres_updated_hiv_plot4, height = 8, width = 14)
)

# Use lapply to apply ggsave to each element in the list
lapply(pngs, function(x) {
  ggsave(filename = x$file, plot = x$plot, path = here("Results", "HIV"),
         height = x$height, width = x$width, device = "png", dpi = 320, bg = "white")
})
```