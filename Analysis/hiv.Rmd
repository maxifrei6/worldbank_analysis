---
title: "Worldbank HIV Analysis"
author: "Leonie Mertes"
date: "`r Sys.Date()`"
output:
  html_document: default
---

## Introduction
This analysis explores relationships of HIV prevalence in the population aged 15-49 to the total alcohol consumption per capita as well as its coherence to percentage of labor force with basic education. Therefore we have two main parts:
1. How does the HIV prevalence in the population aged 15-49 relate to the total alcohol consumption per capita?
2. Do countries with higher percentage of labor force with basic education have lower HIV prevalence rates in the 15-49 population?
<br>
<br>
```{r setup, message = FALSE, echo = FALSE, warning = FALSE}
# Load necessary libraries
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)

source(here("Scripts", "functions.R"))

# Load the dataset
data_merged <- readRDS(here("Data", "Processed", "data_merged.RDS"))
data_grouped <- readRDS(here("Data", "Processed", "data_grouped.RDS"))
data_processed <- left_join(data_merged, data_grouped, by = c("Country Name", "Country Code"))
data_hiv <- data_processed %>%
  select(
    `Country Name`,
    `Country Code`,
    Year,
    SH.DYN.AIDS.ZS,
    SH.ALC.PCAP.LI,
    SL.TLF.BASC.ZS,
    cat_alc,
    cat_education
  )
```
<br>
Check how many NA's in HIV, alcohol and education variable each Year (excluding years existing only of NA's)
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_table <- data_hiv %>%
  group_by(Year) %>%
  reframe(
    num_na_hiv = sum(is.na(SH.DYN.AIDS.ZS)),
    num_na_alc = sum(is.na(SH.ALC.PCAP.LI)),
    num_na_edu = sum(is.na(SL.TLF.BASC.ZS))
  ) %>%
  filter(num_na_hiv < 25 & num_na_alc < 25 & num_na_edu < 25)
print(data_table)
```
<br> 
Auffällig ist, dass es überhaupt keine Daten für Aruba zu geben scheint, daher wird dieses Land im folgenden aus dem Datensatz entfernt, den wir für diese Fragestellung brauchen. Außerdem gibt es keine Daten für Alkoholkonsum 2021.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv <- data_hiv %>%
  filter(`Country Name` != "Aruba") 
data_alc <- data_hiv %>% 
  filter(Year %in% data_table$Year)
```
<br>
<br>
### 1. HIV Prevalence and alcohol consumption
<br>
To take a look at the grouping of our data by alcohol consumption, we will display a plot of the most recent data in Year 2020.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc %>%
  filter(Year == 2020) %>%
  ggplot(aes(`Country Name`, SH.ALC.PCAP.LI, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    y = "Alkoholkonsum in Litern pro Kopf",
    x = "Land",
    title = "Gruppierung der Daten im Jahr 2020",
    colour = "verhältnismäßiger Alkoholkonsum"
  ) +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1,
    size = 4
  )) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Wie hier erkennbar ist, ist die Gruppierung nicht korrekt gerade für die Gruppen "Gering" und "Mittel". Die Alkoholvariable scheint über die Jahre wohl so zu variieren, dass eine jährliche Gruppierung sinvoll ist. Dem werden wir uns im späteren Verlauf dieses Skriptes annehmen.
<br>
Now we take a look at the Comparison of alcohol consumption and HIV prevalence in 2020. Therefore we group by the relative alcohol consumption.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc %>%
  filter(Year == 2020) %>%
  group_by(cat_alc) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Jahr 2020",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
In the following we view the same plot, but without the extreme value. Therefore the country Tanzania is removed.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc %>%
  filter(Year == 2020) %>%
  filter(`Country Name` != "Tansania") %>%
  group_by(cat_alc) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Jahr 2020",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Now we view only one dot per category of relative alcohol consumption.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc %>%
  filter(Year == 2020) %>%
  group_by(cat_alc) %>%
  summarise(
    cat_alc = cat_alc,
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE)
  ) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    title = "Alkoholkonsum vs. HIV Prävalenz im Jahr 2020",
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Just for testing again without the extreme value of Tanzania
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc %>%
  filter(Year == 2020) %>%
  filter(`Country Name` != "Tansania") %>%
  group_by(cat_alc) %>%
  summarise(
    cat_alc = cat_alc,
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE)
  ) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    title = "Alkoholkonsum vs. HIV Prävalenz im Jahr 2020",
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
To get a better overview we take a look at all years.
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv %>%
  group_by(Year, cat_alc) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1,
    size = 6
  )) +
  labs(
    title = "HIV Prävalenz über die Jahre",
    x = "Jahr",
    y = "HIV Prävalenz",
    colour = "relativer Alkoholkonsum"
  ) +
  scale_colour_brewer(palette = "Set2")
# geom_line(aes(group = cat_alc)) + ## nicht korrekt anzunehmen, dass der Verlauf zwischen den jahren stetig/monoton/linear verläuft
```
<br>
Now we take a look over the average of all years, where we categorize by relative alcohol consumption and compare to HIV Prevalence.
<br> 
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv %>%
  group_by(cat_alc) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_alc, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  labs(x = "relativer Alkoholkonsum", y = "HIV Prävalenz in %", title = "Alkoholkonsum vs. HIV Prävalenz im Schnitt über die Jahre")
```
<br>
to take a look at the categorization, we plot the same data in slightly different way:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv %>%
  group_by(cat_alc) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Schnitt über die Jahre",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Wir wollen uns das Verhältnis pro Jahr anschauen und facetten deswegen nun über Jahr mit der allgemeinen Gruppierung.
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv %>%
  group_by(cat_alc) %>%
  ggplot(aes(x = cat_alc, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  facet_wrap( ~ Year) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5,
      size = 6
    ),
    axis.text.y = element_text(size = 5)
  ) +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz",
    subtitle = "Allgemeine Gruppierung"
  ) +
  theme(strip.text = element_text(size = 6, margin = margin(0, 0, 0, 0)))
```
<br>
Erkennbar sind hier nur ganz leichte Schwankungen der Verteilung. Nun wollen wir nochmal auf die Idee mit dem jährlichen gruppieren zurückkommen. 
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Grouping by alcohol consumption values each year and saving this full dataset in data_hiv using function 2.2 group_data_year
data_alc_per_year <- data_alc %>%
  group_by(Year) %>%
  mutate(
    cat_alc_per_year =
      group_data_year(
        df = data_alc,
        grouping_by = "SH.ALC.PCAP.LI",
        year = Year,
        column_new = "alc_per_year",
        quantile_labels = c("Sehr gering", "Gering", "Mittel", "Groß", "Sehr groß")
      )$cat_alc_per_year
  )
```
<br>
Wenn wir uns nun nochmal den Durchschnittsbarplot anschauen, nur dass die Daten jährlich neu gruppiert wurden, sieht dies nun so aus:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc_per_year %>%
  group_by(cat_alc_per_year) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_alc_per_year, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Pro Jahr neu gruppiert"
  )
```
<br>
Hier nun nochmal der plot, der durch die allgemeine Gruppierung hervorgerufen wurde, zum Vergleich:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_hiv %>%
  group_by(cat_alc) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_alc, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Allgemeine Gruppierung"
  )
```
<br>
Um hier auch nochmal die Gruppierung genauer zu betrachten, plotten wir die Daten inklusive Alkoholkonsumvariable:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc_per_year %>%
  group_by(cat_alc_per_year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SH.ALC.PCAP.LI = mean(SH.ALC.PCAP.LI, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SH.ALC.PCAP.LI, SH.DYN.AIDS.ZS, colour = cat_alc_per_year)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Alkoholkonsum in Litern pro Kopf",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Pro Jahr gruppierte Daten",
    colour = "relativer Alkoholkonsum"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Hier sehen wir nun die tatsächlich verbesserte Gruppierung sehr deutlich.
<br>
Wenn wir uns nun die Plots nach Jahr facettiert anschauen wollen mit der neuen Gruppierung, sieht das so aus:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_alc_per_year %>%
  group_by(cat_alc_per_year) %>%
  ggplot(aes(x = cat_alc_per_year, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  facet_wrap( ~ Year) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5,
      size = 6
    ),
    axis.text.y = element_text(size = 5)
  ) +
  labs(
    x = "relativer Alkoholkonsum",
    y = "HIV Prävalenz in %",
    title = "Alkoholkonsum vs. HIV Prävalenz",
    subtitle = "Pro Jahr gruppierte Daten"
  ) +
  theme(strip.text = element_text(size = 6, margin = margin(0.2, 0.2, 0.2, 0.2)))
```
<br>
<br>
### 2. HIV prevalence and basic education
<br>
```{r}
data_edu <- data_hiv %>% 
  filter(`Country Name` != "China") %>% 
  filter(`Country Name` != "Kasachstan")
```
<br>
To take a look at the grouping of our data by basic education of the working force, we will display a plot of the most recent data in Year 2021.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  filter(Year == 2021) %>%
  ggplot(aes(`Country Name`, SL.TLF.BASC.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    y = "Anteil an Arbeitenden mit grundlegender Bildung",
    x = "Land",
    title = "Gruppierung der Daten im Jahr 2021",
    colour = "verhältnismägies Bildungslevel"
  ) +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1,
    size = 4
  )) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Hier sehen wir erneut, dass es wohl sinnvoll wäre für jedes Jahr separat zu gruppieren. Dem werden wir uns später annehmen.
<br>
Now we take a look at the Comparison of percentage of the labor force with basic education and HIV prevalence in 2021. Therefore we group by the relative education level.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  filter(Year == 2021) %>%
  group_by(cat_education) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  coord_cartesian(ylim = c(0, 1.75)) +
  labs(
    x = "Anteil an Arbeitenden mit grundlegender Bildung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Jahr 2021",
    colour = "relativer Bildungsstand"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
This plot is not very meaningful, therfore we try to only plot one dot per category.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  filter(Year == 2021) %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE)
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Anteil an Arbeitenden mit grundlegender Bildung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Jahr 2021",
    colour = "relativer Bildungsstand"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2") 
```
<br>
Now we see a upwards tendency (even without the extreme value).
We notice as well that there is no value for the category "Medium" relative education. Therefore we take a look at 2020.
<br>
```{r, echo=FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  filter(Year == 2020) %>%
  group_by(cat_education) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Anteil an Arbeitenden mit grundlegender Bildung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Jahr 2020",
    colour = "relativer Bildungsstand"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Is there really an downwards tendency?
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  filter(Year == 2020) %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Anteil an Arbeitenden mit grundlegender Bildung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Jahr 2020",
    colour = "relativer Bildungsstand"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
Unfortunately in mean the graph is still upwards. Maybe plot over years to get an overview.
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  group_by(Year, cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  theme(axis.text.x = element_text(
    angle = 45,
    hjust = 1,
    size = 6
  )) +
  labs(
    title = "HIV Prävalenz über die Jahre",
    x = "Jahr",
    y = "HIV Prävalenz",
    colour = "relativer Bildungsstand"
  )  +
  scale_colour_brewer(palette = "Set2")
```
<br>
The 60 % with higher education level also show a higher HIV Prevalence. Their Prevalence is falling over the years, while countries with lower education level have an small tendency to increasing HIV prevalence. The labor force with relativly medium
education have a higher HIV Prevalence than the others.
<br>
Now we take a look at all years, facetted by cat_education, all countries each a line
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  ggplot(aes(Year, SH.DYN.AIDS.ZS)) +
  geom_point(size = 2, alpha = 0.4) +
  facet_wrap( ~ cat_education) +
  geom_line(aes(group = `Country Name`)) +
  labs(
    title = "HIV Prävalenz vs Grundbildung je nach relativem Bildungsstand",
    x = "Anteil grundlegend gebildeter Arbeitskräfte",
    y = "HIV Prävalenz",
    colour = "Land"
  )  +
  scale_colour_brewer(palette = "Set2")
```
<br>
Here we see clearly that some countries change their education group to belong to over the years. Therefore we should try to group the data per year later.
<br>
We want to create a plot of the averages over all years grouped by education level. For interest first with x-axis education and second as bar plot (x axis the education level)
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_education)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    x = "Anteil an Arbeitenden mit grundlegender Bildung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Schnitt über die Jahre",
    colour = "relativer Bildungsstand"
  ) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE) +
  scale_colour_brewer(palette = "Set2")
```
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  group_by(cat_education) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = cat_education, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "relatives Bildungslevel der arbeitsfähigen Bevölkerung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz im Schnitt über die Jahre"
  )
```
<br>
nun bar plots facettiert nach jahr. Nur um zu sehen, dass die Unterschiede der verschiedenen Gruppen betragsmäßig zurückgegangen sind. Die HIV-Prävalenz ist über die Jahre insgesamt gesunken, besonders aber bei Ländern mit ehemals den mit Abstand höchsten HIV Werten.
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  ggplot(aes(x = cat_education, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  facet_wrap(~Year) +
  labs(
    x = "relatives Bildungslevel der arbeitsfähigen Bevölkerung",
    y = "HIV Prävalenz in %",
    title = "Bildungsstand vs. HIV Prävalenz pro Jahr",
    subtitle = "Allgemeine Gruppierung"
  ) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5,
      size = 8
    ),
    axis.text.y = element_text(size = 8)
  ) +
  theme(strip.text = element_text(size = 10, margin = margin(0.2, 0.2, 0.2, 0.2)))
```
<br>
Und nun zu der jährlichen Gruppierungen:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
# Grouping by basic education values each year and saving this full dataset in data_edu using function 2.2 group_data_year
data_edu <- data_edu %>%
  group_by(Year) %>%
  mutate(
    cat_edu_per_year =
      group_data_year(
        df = data_edu,
        grouping_by = "SL.TLF.BASC.ZS",
        year = Year,
        column_new = "edu_per_year",
        quantile_labels = c("Sehr schlecht", "Schlecht", "Mittel", "Gut", "Sehr gut")
      )$cat_edu_per_year
  )
# sehr viele NA values in neuer Spalte cat_edu_per_year
data_edu <- data_edu %>% 
  filter(!is.na(cat_edu_per_year))
```
<br>
Wenn wir uns nun nochmal den Durchschnittsbarplot anschauen, nur dass die Daten jährlich neu gruppiert wurden, sieht dies nun so aus:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu %>%
  group_by(cat_edu_per_year) %>%
  summarise(SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
            .groups = "drop") %>%
  ggplot(aes(x = cat_edu_per_year, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  labs(
    x = "relativer Bildungsstand",
    y = "HIV Prävalenz in %",
    title = "Grundbildung vs. HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Pro Jahr neu gruppiert"
  )
```
<br>
Um hier auch nochmal die Gruppierung genauer zu betrachten, plotten wir die Daten inklusive Grundbildungsvariable:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  summarise(
    SH.DYN.AIDS.ZS = mean(SH.DYN.AIDS.ZS, na.rm = TRUE),
    SL.TLF.BASC.ZS = mean(SL.TLF.BASC.ZS, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(SL.TLF.BASC.ZS, SH.DYN.AIDS.ZS, colour = cat_edu_per_year)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(
    colour = "relativer Bildungsstand",
    y = "HIV Prävalenz in %",
    title = "Grundbildung vs. HIV Prävalenz im Schnitt über die Jahre",
    subtitle = "Pro Jahr neu gruppiert",
    x = "Anteil an Arbeitenden mit grundlegender Bildung"
  ) + 
  scale_colour_brewer(palette = "Set2")
```
<br>
Hier sehen wir nun die tatsächlich verbesserte Gruppierung sehr deutlich.
<br>
Wenn wir uns nun die Plots nach Jahr facettiert anschauen wollen mit der neuen Gruppierung, sieht das so aus:
<br>
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "left"}
data_edu_per_year %>%
  group_by(cat_edu_per_year) %>%
  ggplot(aes(x = cat_edu_per_year, y = SH.DYN.AIDS.ZS)) +
  geom_col(fill = "steelblue") +
  facet_wrap( ~ Year) +
  theme(
    axis.text.x = element_text(
      angle = 90,
      hjust = 1,
      vjust = 0.5,
      size = 9
    ),
    axis.text.y = element_text(size = 8)
  ) +
  labs(
    x = "relativer Bildungsstand",
    y = "HIV Prävalenz in %",
    title = "Grundbildung vs. HIV Prävalenz",
    subtitle = "Pro Jahr neu gruppiert"
  ) +
  theme(strip.text = element_text(size = 8, margin = margin(0.2, 0.2, 0.2, 0.2)))
```