---
title: "Worldbank Agriculture Analysis"
author: "Robin Billinger"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

## Introduction
This analysis explores relationships between indicators across countries such as percentage of agricultural land, CO2 emissions per capita, and size of surface area using World Bank data. It is divided into two main parts:  

1. Is there a relationship between the percentage of agricultural land and CO2 emissions per capita across countries?
2. Does the size of the surface area of the country play a role?.
<br>
<br>

```{r setup, echo = FALSE, message = FALSE}
# Load libraries
library(dplyr)
library(ggplot2)
library(tidyr)

# Load the processed "data_merged" dataset
data_agriculture <- readRDS("/Users/rb.bllngr/Desktop/worldbank_analysis/Data/Processed/data_merged.RDS")
################################### data_agriculture <- readRDS(normalizePath("Data/Processed/data_merged.RDS"))

# Filter relevant columns
data_agriculture <- data_agriculture %>%
  select(`Country Name`, `Country Code`, Year, AG.LND.AGRI.ZS, AG.SRF.TOTL.K2, EN.GHG.CO2.MT.CE.AR5)

# Convert column `Year` to data type Integer
data_agriculture$Year <- as.integer(data_agriculture$Year)

# Save the ascending order of average change in agricultural land [%] by country
country_order_by_agrLand <- data_agriculture %>%
  group_by(`Country Name`) %>%
  summarise(avg_AG.LND.AGRI.ZS = mean(AG.LND.AGRI.ZS)) %>%
  arrange(avg_AG.LND.AGRI.ZS) %>%
  pull(`Country Name`)
```

### 1. Percentage of agricultural land and CO2 emissions per capita
We analyze whether the percentage of agricultural land relates to the CO2 emissions per capita. To get an overview over the interested data and be able to to evaluate future insights correctly, we start by looking at the two indicators separately. Starting with the distribution of the CO2 emissions, we get the following information.

```{r CO2 emissions, echo = FALSE, , warning = FALSE, message = FALSE}
# Load libraries
library(RColorBrewer)
# Heatmap displaying the development of CO2 emissions per capita across countries
ggplot(data_agriculture, aes(x = factor(Year), y = `Country Name`, fill = log10(EN.GHG.CO2.MT.CE.AR5 + 1))) +
  geom_tile(col = "white") +  # Create heatmap tiles
  scale_fill_gradient(low = brewer.pal(9, "Blues")[1],
                      high = brewer.pal(9, "Blues")[9],
                      name = "Logarithmierte CO2 Emissionen\npro Kopf",
                      breaks = log10(c(0, 100, 1000, 10000, 100000) + 1),
                      labels = c("0", "100", "1.000", "10.000", "100.000")) +  # Gradient color scale
  ggtitle("CO2 Emissionen pro Kopf") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title.position = "left", 
        legend.title = element_text(hjust = 0.5),
        legend.text = element_text(angle = -45, hjust = 0),
        axis.text.x = element_text(hjust = 0.5)) +
  labs(x = "Jahr", y = "Land")

# Get an overview over the CO2 emissions data
cat("\n", summary(data_agriculture$EN.GHG.CO2.MT.CE.AR5),"\n")

# Save the ascending order of within-country variance in CO2 emissions
country_order_by_CO2variance <- data_agriculture %>%
  group_by(`Country Name`) %>%
  summarise(avg_EN.GHG.CO2.MT.CE.AR5 = mean(EN.GHG.CO2.MT.CE.AR5)) %>%
  arrange(avg_EN.GHG.CO2.MT.CE.AR5) %>%
  pull(`Country Name`)

# Compute the between-country variance in CO2 emissions
data_agriculture_variance_between_CO2 <- var(data_agriculture %>%
                                               group_by(`Country Name`) %>%
                                               summarise(Average_CO2 = mean(EN.GHG.CO2.MT.CE.AR5)) %>%
                                               select(Average_CO2))

# Create boxplots for within-country variances (vertical reference line showing the between-country variance)
ggplot(data_agriculture,
       aes(x = EN.GHG.CO2.MT.CE.AR5, y = factor(`Country Name`, levels = country_order_by_CO2variance))) +
  geom_boxplot() +
  # geom_vline(xintercept = data_agriculture_variance_between_CO2,
  #            color = "black", linetype = "dashed", size = 1.2) +  # Between-country variance
  labs(title = "Streuungszerlegung der CO2 Emissionen pro Kopf bezüglich Ländern",
       x = "CO2 Emissionen pro Kopf [mt]", y = "Land") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

cat("Streuung zwischen den Ländern: " , data_agriculture_variance_between_CO2)

```
<br>
The CO2 emissions have high variance within the countries. Simultaneously, there are enormous differences in absolute amounts between the countries. Therefore, the greatest challenge may lie in comparing the different countries' values and trends although the data is provided on a per capita basis.
<br>
Furthermore, the distribution of the percentage of agricultural land delivers the following information.

```{r agricultural land, echo = FALSE, , warning = FALSE, message = FALSE}
# Country-facetted line plot displaying the development of agricultural land [%] ordered by ascending mean [%]
ggplot(data_agriculture, aes(x = Year, y = AG.LND.AGRI.ZS)) +
  geom_line() +  
  ggtitle("Landwirtschaftliche Nutzfläche") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.title = element_text(hjust = 0.5),
        legend.title.position = "left",
        legend.direction = "horizontal",
        axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels
  labs(x = "Jahr", y = "Anteil [%]") +
  facet_wrap(~ factor(data_agriculture$`Country Name`, levels = country_order_by_agrLand), ncol = 5)

# Get an overview over the agriculture data
cat("\n", summary(data_agriculture$AG.LND.AGRI.ZS), "\n")

# Compute the between-country variance in CO2 emissions
data_agriculture_variance_between_agrLand <- var(data_agriculture %>%
                                                    group_by(`Country Name`) %>%
                                                    summarise(Average_agrLand = mean(AG.LND.AGRI.ZS)) %>%
                                                    select(Average_agrLand))

# Create boxplots for within-country variances (vertical reference line showing the between-country variance)
ggplot(data_agriculture,
       aes(x = AG.LND.AGRI.ZS, y = factor(`Country Name`, levels = country_order_by_agrLand))) +
  geom_boxplot() +
  # geom_vline(xintercept = data_agriculture_variance_between_agrLand,
  #           color = "black", linetype = "dashed", size = 1.2) +  # Between-country variance
  labs(title = "Streuungszerlegung der landwirtschaftlichen Nutzfläche bezüglich Ländern",
       x = "Landwirtschaftliche Nutzfläche [%]", y = "Land") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

cat("Streuung zwischen den Ländern: ", data_agriculture_variance_between_agrLand)

```
<br> 
In contrast to the CO2 emissions, the percentages of agricultural land have rather low variance within the countries. However, there are recognizable deviations between the countries, spanning from only five to up to eighty percent. As we operate on a capped percentage scale though, comparisons should be possible quite well.
<br>
Moving on, we want to bring those two variables back together. For this purpose, analyzing the distribution of the collected data while disregarding the country-specific origin gives us this cloud of data points. Note, that the CO2 emissions are displayed logarithmic to counter the expansive value disparity in the data.

```{r scatterplot initial position, echo = FALSE, , warning = FALSE, message = FALSE}
# Initial comparison via scatterplot of agricultural land [%] and CO2 emissions per capita [mt]
ggplot(data_agriculture, aes(x = log10(EN.GHG.CO2.MT.CE.AR5 + 1), y = AG.LND.AGRI.ZS)) +
  geom_point(alpha = .3, size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(title = "Zusammenhang zwischen CO2 Emissionen pro Kopf\nund landwirtschaftlicher Nutzfläche",
       x = "Logarithmierte CO2 Emissionen pro Kopf [mt]", y = "Landwirtschaftliche Nutzfläche [%]") +
  # scale_x_log10(name = "CO2 Emissionen pro Kopf",
  #               breaks = log10(c(0, 10, 100, 1000, 10000, 100000) + 1),
  #               labels = c("0", "10", "100", "1.000", "10.000", "100.000")) +
  # scale_x_log10(breaks = trans_breaks("log10", function(x) 10 ^ x),
  #               labels = trans_format("log10", function(x) as.character(10 ^ x))) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
<br>
We can recognize a slightly positive linear trend between the variables. However, the development over time and the country-specification of observations are completely ignored. In order to take those factors back into consideration, we first distinguish among the countries by facetting our visualization for an in depth comparison of the indicators for each country over time.

``` {r facetted scatterplot logarithmic, echo = FALSE, , warning = FALSE, message = FALSE}
# Logarithmic CO2 emissions by country, average agricultural land [%] for color and facetting order
ggplot(data_agriculture, aes(colour = AG.LND.AGRI.ZS)) +
  geom_point(aes(x = Year, y = log10(EN.GHG.CO2.MT.CE.AR5 + 1))) +
  scale_color_distiller(name = "Landwirtschaftliche Nutzfläche [%]",
                        palette = "Oranges",
                        direction = 1,
                        breaks = c(0, 20, 40, 60, 80, 100),
                        labels = c("0", "20", "40", "60", "80", "100")) +
  labs(title = "Zusammenhang zwischen CO2 Emissionen pro Kopf\nund landwirtschaftlicher Nutzfläche",
       x = "Jahr", y = "Logarithmierte CO2 Emissionen pro Kopf [mt]") +
  theme_bw() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_rect(fill = "white")) +  # Change the color for better contrast?
  facet_wrap(~ factor(data_agriculture$`Country Name`, levels = country_order_by_agrLand), ncol = 5)
```
<br> 
The in ascending percentage of agricultural land sorted facets show no obvious connection between the two indicators, as the CO2 emissions are developing quite arbitrarily regardless of the associated percentage of agricultural land.
<br>
To dig even further, we now adjust the data by normalizing the CO2 emissions within each country, letting us investigate relative changes on the same scale as the agricultural land.

```{r facetted scatterplot normalized, echo = FALSE, , warning = FALSE, message = FALSE}
# Normalize variable CO2 emissions to same scale as agricultural land [%]
data_agriculture_normd <- data_agriculture %>%
  group_by(`Country Name`) %>%
  mutate(
    co2_min = min(EN.GHG.CO2.MT.CE.AR5),
    co2_max = max(EN.GHG.CO2.MT.CE.AR5),
    co2_normd = ((EN.GHG.CO2.MT.CE.AR5 - co2_min) / (co2_max - co2_min))
  ) %>%
  ungroup()

# Pivot normalized data_agriculture dataset to longer format for better visualization of two variables
data_agriculture_normd_long <- data_agriculture_normd %>%
  pivot_longer(cols = c(co2_normd, AG.LND.AGRI.ZS), names_to = "variable", values_to = "value") %>%
  mutate(value = case_when(
    variable == "co2_normd" ~ value * 100,  # used for [%] comparison
    variable == "AG.LND.AGRI.ZS" ~ value))

# Plotting with normalized data over time for each country
ggplot(data_agriculture_normd_long,
       aes(x = Year, y = value, color = variable, group = interaction(`Country Name`, variable))) +
  geom_point() +  # or geom_line? (And is geom_line overdramatizing the (wrong?) outliers in CO2 emissions?)
  labs(title = "Zusammenhang zwischen CO2 Emissionen pro Kopf\nund landwirtschaftlicher Nutzfläche",
       x = "Jahr", y = "Anteil", color = "") +
  scale_color_brewer(palette = "Set1",  # Colorblind-friendly palette
                     labels = c("Landwirtschaftliche Nutzfläche [%]",
                                "(Min, Max)-normalisierte CO2 Emissionen pro Kopf [%]")) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2020),  # Text labels for x-axis
                     minor_breaks = seq(2000, 2021, by = 1)) +  # Add ticks
  theme_bw() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_text(hjust = 0.5)) +
  facet_wrap(~ factor(data_agriculture_normd_long$`Country Name`, levels = country_order_by_agrLand), ncol = 5)

```
<br> 
As we can see, there seems to be no direct relationship between the countries' percentage of agricultural land and their CO2 emissions per capita. 

### 2. Influence of surface area on previous relationship
