---
title: "Worldbank Agriculture Analysis"
author: "Robin Billinger"
date: "`r Sys.Date()`"
output:
  html_document:
    self-contained: true
    clean: true
---

## Introduction
This analysis explores relationships between indicators across countries such as percentage of agricultural land, CO2 emissions per capita, and size of surface area using World Bank data. It is divided into two main parts, with this script focusing on the first question. For further observation of the second question, refer to the file 'Analysis/agriculture.Rmd'.
<br><br>
1. Is there a relationship between the **percentage of agricultural land** and **CO2 emissions per capita** across countries?
<br><br>
2. Does the size of the surface area of the country play a role?
<br>

```{r setup, echo = FALSE, message = FALSE}
# Load libraries
library(knitr)
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)
library(RColorBrewer)

# Globally center all plots while displaying knitted version in HTML
knitr::opts_chunk$set(fig.align = "center")

# Load the processed 'data_merged' data set using 'here'
data_agriculture <- readRDS(here("Data", "Processed", "data_merged.RDS"))

# Filter relevant columns
data_agriculture <- data_agriculture %>%
  select(`Country Name`,
         `Country Code`,
         Year,
         AG.LND.AGRI.ZS,
         AG.SRF.TOTL.K2,
         EN.GHG.CO2.MT.CE.AR5)

# Convert column 'Year' to data type integer
data_agriculture$Year <- as.integer(data_agriculture$Year)

# Save the agriculture data set using 'here' for the file path.
if (!file.exists(here("Data", "Processed", "data_agriculture.RDS"))) {
  saveRDS(data_agriculture, file = here("Data", "Processed", "data_agriculture.RDS"))
}

# Save the ascending order of average agricultural land [%] by country
country_order_by_agrLand <- data_agriculture %>%
  group_by(`Country Name`) %>%
  summarise(avg_AG.LND.AGRI.ZS = mean(AG.LND.AGRI.ZS)) %>%
  ungroup() %>%
  arrange(avg_AG.LND.AGRI.ZS) %>%
  pull(`Country Name`)
```

### 1. Percentage of agricultural land and CO2 emissions per capita
We analyze whether the percentage of agricultural land relates to the CO2 emissions per capita. To get an overview over the interested data and be able to evaluate future insights correctly, we start by looking at the two indicators separately.
<br><br>
Starting with the distribution of the CO2 emissions, we get the following information.

```{r heatmap_co2, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Save the ascending order of average CO2 emissions
country_order_by_CO2variance <- data_agriculture %>%
  group_by(`Country Name`) %>%
  summarise(avg_EN.GHG.CO2.MT.CE.AR5 = mean(EN.GHG.CO2.MT.CE.AR5)) %>%
  ungroup() %>%
  arrange(avg_EN.GHG.CO2.MT.CE.AR5) %>%
  pull(`Country Name`)

# Heat map displaying the development of CO2 emissions per capita across countries
ggplot(data_agriculture,
       aes(x = factor(Year),
           y = factor(`Country Name`, levels = country_order_by_CO2variance),
           fill = log10(EN.GHG.CO2.MT.CE.AR5 + 1))) +
  geom_tile(col = "black") +
  ggtitle("CO2 Emissionen pro Kopf nach Ländern") +
  scale_x_discrete(name = "Jahr", breaks = seq(2000, 2021, by = 1)) +
  scale_y_discrete(name = "Land") +
  scale_fill_viridis_c(name = "CO2 Emissionen pro Kopf\n[Mt] (Log10)",
                       direction = -1,
                       option = "plasma",
                       breaks = log10(c(0, 10, 100, 1000, 10000) + 1),
                       labels = c("0", "10", "100", "1.000", "10.000")) +
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = 0.5),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.text = element_text(angle = -45, hjust = 0),
        legend.title.position = "left", 
        legend.title = element_text(hjust = 0.5, vjust = 0.8),
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Get an overview over the CO2 emissions data
summary(data_agriculture$EN.GHG.CO2.MT.CE.AR5)
```

It appears that occasionally there are immense differences within countries' values from one year to another, displayed by clear jumps in the sequential color scale. After further investigation of this phenomenon and consultation with our supervisors, we came to the conclusion that the false values originate from database-caused mishandle during the data set's download. Moving forward, we accept these anomalies and handle them as the error-produced outliers as they are.

```{r boxplot_co2, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Create boxplots for within-country variances
ggplot(data_agriculture,
       aes(x = log10(EN.GHG.CO2.MT.CE.AR5 + 1),
           y = factor(`Country Name`, levels = country_order_by_CO2variance))) +
  geom_boxplot() +
  ggtitle("Streuungszerlegung der CO2 Emissionen pro Kopf bezüglich Ländern") +
  scale_x_continuous(name = "CO2 Emissionen pro Kopf [Mt] (Log10)",
                     breaks = log10(c(0, 10, 100, 1000, 10000) + 1),
                     labels = c("0", "10", "100", "1.000", "10.000")) +
  scale_y_discrete(name = "Land") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

# Compute the between-country variance in CO2 emissions
data_agriculture_variance_between_CO2 <-
  var(data_agriculture %>%
        group_by(`Country Name`) %>%
        summarise(avg_CO2 = mean(EN.GHG.CO2.MT.CE.AR5)) %>%
        ungroup() %>%
        select(avg_CO2))

cat("Streuung zwischen den Ländern: ", data_agriculture_variance_between_CO2, "\n")
```
<br>
The CO2 emissions have high variance within the countries. Simultaneously, there are enormous differences in absolute amounts between the countries. Therefore, the greatest challenge may lie in comparing the different countries' values and trends although the data is provided on a per capita basis.
<br>
Furthermore, the distribution of the percentage of agricultural land delivers the following information.

```{r faceted_line_agrLand, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Country-faceted line plot displaying the development of agricultural land [%] ordered by
# ascending mean [%]
ggplot(data_agriculture, aes(x = Year, y = AG.LND.AGRI.ZS)) +
  geom_line() +  
  ggtitle("Landwirtschaftliche Nutzfläche nach Ländern") +
  scale_x_discrete(name = "Jahr", breaks = seq(2000, 2020, by = 5)) +
  scale_y_continuous(name = "Landwirtschaftliche Nutzfläche [%]", limits = c(0, 100)) +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.title = element_text(hjust = 0.5),
        legend.title.position = "left",
        legend.direction = "horizontal",
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ factor(data_agriculture$`Country Name`,
                      levels = country_order_by_agrLand), ncol = 5)

# Get an overview over the agriculture data
summary(data_agriculture$AG.LND.AGRI.ZS)
```
<br>

```{r boxplot_agrLand, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Compute the between-country variance in CO2 emissions
data_agriculture_variance_between_agrLand <-
  var(data_agriculture %>%
        group_by(`Country Name`) %>%
        summarise(Average_agrLand = mean(AG.LND.AGRI.ZS)) %>%
        ungroup() %>%
        select(Average_agrLand))

# Create boxplots for within-country variances
ggplot(data_agriculture,
       aes(x = AG.LND.AGRI.ZS,
           y = factor(`Country Name`, levels = country_order_by_agrLand))) +
  geom_boxplot() +
  ggtitle("Streuungszerlegung der landwirtschaftlichen Nutzfläche bezüglich Ländern") +
  scale_x_continuous(name = "Landwirtschaftliche Nutzfläche [%]") +
  scale_y_discrete(name = "Land") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

cat("Streuung zwischen den Ländern: ", data_agriculture_variance_between_agrLand)
```
<br> 
In contrast to the CO2 emissions, the percentages of agricultural land have rather low variance within the countries. However, there are recognizable deviations between the countries, spanning from only five to up to eighty percent. As we operate on a capped percentage scale though, comparisons should be possible quite well.
<br> <br>
Moving on, we want to bring those two variables back together. For this purpose, analyzing the distribution of the collected data while disregarding the country-specific origin gives us the following cloud of data points. Note, that the CO2 emissions are displayed logarithmic to counter the expansive value disparity in the data.

```{r scatter_agrLand_co2, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Initial comparison via scatter plot of agricultural land [%] and CO2 emissions per
# capita [Mt]
ggplot(data_agriculture, aes(x = log10(EN.GHG.CO2.MT.CE.AR5 + 1), y = AG.LND.AGRI.ZS)) +
  geom_point(alpha = .3, size = 2.5) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  ggtitle(paste0("Zusammenhang zwischen CO2 Emissionen pro Kopf und ",
                 "landwirtschaftlicher Nutzfläche")) +
  scale_x_continuous(name = "CO2 Emissionen pro Kopf [Mt] (Log10)",
                     breaks = log10(c(0, 10, 100, 1000, 10000) + 1),
                     labels = c("0", "10", "100", "1.000", "10.000")) +
  scale_y_continuous(name = "Landwirtschaftliche Nutzfläche [%]") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))
```
<br>
We can recognize a slightly positive linear trend between the variables. However, the development over time and the country-specification of observations are completely ignored. In order to take those factors back into consideration, we first distinguish among the countries by faceting our visualization for an in-depth comparison of the indicators for each country over time.
<br>

```{r faceted_scatter_agrLand_co2, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# Logarithmic CO2 emissions by country, average agricultural land [%] for color and
# faceting order
ggplot(data_agriculture, aes(x = Year, y = log10(EN.GHG.CO2.MT.CE.AR5 + 1))) +
  geom_point(aes(fill = AG.LND.AGRI.ZS), size = 2, shape = 21, stroke = 0.5) +
  ggtitle(paste0("Zusammenhang zwischen CO2 Emissionen pro Kopf und ",
                 "landwirtschaftlicher Nutzfläche nach Ländern")) +
  scale_x_discrete(name = "Jahr", breaks = seq(2000, 2020, by = 5)) +
  scale_y_continuous(name = "CO2 Emissionen pro Kopf [Mt] (Log10)",
                     breaks = log10(c(0, 10, 100, 1000, 10000) + 1),
                     labels = c("0", "10", "100", "1.000", "10.000")) +
  scale_fill_viridis_c(name = "Landwirtschaftliche Nutzfläche [%]",
                       direction = -1, option = "plasma") +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 0.5),
        legend.direction = "horizontal",
        legend.position = "bottom",
        legend.title.position = "left", 
        legend.title = element_text(hjust = 0.5, vjust = 0.8),
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ factor(data_agriculture$`Country Name`,
                      levels = country_order_by_agrLand), ncol = 5)
```
<br>
The chosen format of the scatter plot instead of line visualization attempts to counter the false entries for CO2 emissions, as for lines the error-caused outliers are displayed in a more extreme way leading us to scatters instead.
<br> <br>
However, the in ascending percentage of agricultural land sorted facets show no obvious connection between the two indicators, as the CO2 emissions are developing quite arbitrarily regardless of the associated percentage of agricultural land.
<br>
To dig even further, we now adjust the data by normalizing the CO2 emissions within each country, letting us investigate relative changes on the same scale as the agricultural land.

```{r faceted_normd_scatter_agrLand_co2, echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}
# (Min; Max)-normalize variable CO2 emissions to same scale as agricultural land [%]
data_agriculture_normd <- data_agriculture %>%
  group_by(`Country Name`) %>%
  mutate(
    co2_min = min(EN.GHG.CO2.MT.CE.AR5),
    co2_max = max(EN.GHG.CO2.MT.CE.AR5),
    co2_normd = ((EN.GHG.CO2.MT.CE.AR5 - co2_min) / (co2_max - co2_min))
  ) %>%
  ungroup()

# Pivot normalized data_agriculture data set to longer format for better visualization of two variables
data_agriculture_normd_long <- data_agriculture_normd %>%
  pivot_longer(cols = c(co2_normd, AG.LND.AGRI.ZS),
               names_to = "variable", values_to = "value") %>%
  mutate(value = case_when(
    variable == "co2_normd" ~ value * 100,  # used for [%] comparison
    variable == "AG.LND.AGRI.ZS" ~ value))

# Plotting with normalized data over time for each country
ggplot(data_agriculture_normd_long,
       aes(x = Year, y = value, group = interaction(`Country Name`, variable))) +
  geom_point(aes(fill = variable), alpha = 0.75, size = 2, shape = 21, stroke = 0.5) +
  ggtitle(paste0("Zusammenhang zwischen CO2 Emissionen pro Kopf und ",
                 "landwirtschaftlicher Nutzfläche nach Ländern")) +
  scale_x_discrete(name = "Jahr", breaks = seq(2000, 2020, by = 5)) +
  scale_y_continuous(name = "Anteil [%]", limits = c(0, 100)) +
  scale_fill_brewer(name = "", palette = "Set2",  # Colorblind-friendly palette
                    labels = c("Landwirtschaftliche Nutzfläche [%]",
                               "(Min; Max)-normalisierte CO2 Emissionen pro Kopf [%]")) +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ factor(data_agriculture_normd_long$`Country Name`,
                      levels = country_order_by_agrLand), ncol = 5)
```
<br> 
As we can see, there seems to be no direct relationship between the countries' percentages of agricultural land and their CO2 emissions per capita.
<br><br><br>
**To now further observe the potential influence of countries' surface areas on this relationship, refer to the 'surface.Rmd' file.**


