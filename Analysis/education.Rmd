---
title: "Worldbank Education Analysis"
author: "Maximilian Frei"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

## Introduction
This analysis explores relationships between indicators such as central government debt, labor force education levels, and pupil-teacher ratios using World Bank data. It is divided into two main parts:  

1. Relationship between central government debt and labor force education.  
2. Relationship between labor force education and pupil-teacher ratios, focusing on implications for education quality.
<br>
<br>

First we will take a look at the data which is available to us. insert a few data exploration steps, grouping, head,

```{r edu_setup, message=FALSE, echo = FALSE}
# Load necessary libraries
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)

# Load the dataset
data_merged <- readRDS(here("Data", "Processed", "data_merged.RDS"))
data_grouped <- readRDS(here("Data", "Processed", "data_grouped.RDS"))
data_education <- left_join(data_merged, data_grouped, by = c("Country Name", "Country Code"))
```

### 1 Central Government Debt and Labor Force Education
We analyze whether countries with higher central government debt as a percentage of GDP have lower percentages of labor force with basic education. Let's first create a scatter plot including a robust trend line to visualize the relationship.
<br>
<br>
```{r scatter-debt-education, message=FALSE, echo = FALSE, warning=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
p7 <- ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

```

<br>

In our attempt to plot this relationship we've encountered a high proportion of missing data pairs.

```{r edu_2, echo = FALSE}
data_education %>%
  group_by(cat_income_level) %>%
  summarise(
    total_rows = n(),
    missing_debt = sum(is.na(GC.DOD.TOTL.GD.ZS)),
    missing_debt_share = round((missing_debt / total_rows) * 100, 2),
    missing_education = sum(is.na(SL.TLF.BASC.ZS)),
    missing_education_share = round((missing_education / total_rows) * 100, 2)
  ) %>%
  as.data.frame() # Ensure full output display

# Summarize data for NA and Not NA
missing_data_summary <- data_education %>%
  group_by(cat_income_level) %>%
  summarise(
    debt_missing = sum(is.na(GC.DOD.TOTL.GD.ZS)),
    debt_not_missing = sum(!is.na(GC.DOD.TOTL.GD.ZS)),
    education_missing = sum(is.na(SL.TLF.BASC.ZS)),
    education_not_missing = sum(!is.na(SL.TLF.BASC.ZS))
  ) %>%
  pivot_longer(
    cols = c(debt_missing, debt_not_missing, education_missing, education_not_missing),
    names_to = c("variable", "status"),
    names_sep = "_",
    values_to = "count"
  )

# Create a bar chart
ggplot(missing_data_summary, aes(x = cat_income_level, y = count, fill = status)) +
  geom_bar(stat = "identity", position = "fill") + # Stacked bar showing proportions
  facet_wrap(~variable, labeller = as_labeller(c(
    "debt" = "Debt Data (GC.DOD.TOTL.GD.ZS)",
    "education" = "Education Data (SL.TLF.BASC.ZS)"
  ))) +
  labs(
    title = "Comparison of NA vs Not NA by Income Level",
    x = "Income Level",
    y = "Proportion",
    fill = "Data Status"
  ) +
  scale_fill_manual(values = c("missing" = "red", "not_missing" = "green"), labels = c("Missing", "Not Missing")) +
  theme_bw()

# Summarize available data pairs for each country
available_data_pairs <- data_education %>%
  group_by(`Country Name`) %>%
  summarise(
    available_pairs = sum(!is.na(GC.DOD.TOTL.GD.ZS) & !is.na(SL.TLF.BASC.ZS)) # Count rows where both variables are not NA
  ) %>%
  arrange(desc(available_pairs)) # Arrange by descending order of available pairs

# Create a bar chart to visualize the data pairs
ggplot(available_data_pairs, aes(x = reorder(`Country Name`, -available_pairs), y = available_pairs)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Available Data Pairs for Each Country",
    x = "Country Name",
    y = "Total Data Pairs"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) # Rotate x-axis labels for better readability
```

<br>

By diving deeper into the data that is available to us we can see that only 10 countries with varying representation are availble to us. To make the our analysis less prone to outliers we will use more robust models and techniques like "" correlation coefficients and continue using a robust linear model to generate trend lines.



Insert correlation coefficients for years and overall trend...explain why whe choose this particular coefficient to work against the data quality concerns


```{r scatter-debt-education-years, echo = FALSE, warning=FALSE, message=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  facet_wrap(~ Year) +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()
```

<br>

### Interpretation 
At first glance, there is a positive correlation between debt and education quality across time, though the high proportion of missing data requires further investigation. 

Analyzing this relationship by income levels is a logical next step, as income significantly impacts a country's ability to invest in education and manage debt. This approach can reveal how economic disparities influence the correlation and highlight potential structural inequities.

<br>

```{r scatter-debt-education-income-lvls, echo = FALSE, , warning=FALSE, message=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS, color = cat_income_level)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(color = cat_income_level), method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)",
    color = "income level"
  ) +
  scale_fill_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

p1 <- ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS, color = cat_income_level)) +
  geom_point(alpha = 0.6) +
  geom_smooth(aes(color = cat_income_level), method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Zentralstaatliche Verschuldung vs Anteil grundlegender Bildung",
    x = "Zentralstaatliche Verschuldung [% des BIP]",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  scale_fill_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(name = "Einkommensniveau", values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"), labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")) +
  theme_bw()

p1

```

<br>

We can observe a certain clustering of our data points that seem to show opposite effects. To make the relationships for each subgroup more apparent we will create seperate facetted plots for each income level.

<br>
```{r scatter-debt-education-facet, echo = FALSE, message=FALSE, warning=FALSE}
# Create a named vector to translate the income level facets
# Faceted scatter plot: Debt vs Education by Income Level
# Calculate correlations for each income level
cor_matrix_1 <- data_education %>%
  group_by(cat_income_level) %>%
  summarise(
    correlation = round(cor(GC.DOD.TOTL.GD.ZS, SL.TLF.BASC.ZS, method = "spearman", use = "complete.obs"), 2)
  )

# Merge correlations back into the original data for placement
data_with_cor <- data_education %>%
  left_join(cor_matrix_1, by = "cat_income_level")

income_labels <- c(
  "Low" = "Geringes Einkommen",
  "Medium" = "Mittleres Einkommen",
  "High" = "Hohes Einkommen"
)

# Update the ggplot with the labeller for translated facet titles
p2 <- ggplot(data_with_cor, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  facet_wrap(~ cat_income_level, labeller = labeller(cat_income_level = income_labels)) +
  labs(
    title = "Zentralstaatliche Verschuldung vs Anteil grundlegender Bildung",
    x = "Zentralstaatliche Verschuldung [% des BIP]",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme_bw() +
  geom_text(
    data = cor_matrix_1,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,  # Adjust horizontal alignment
    vjust = 1.5,  # Adjust vertical alignment
    size = 4,
    color = "black",
    parse = TRUE  # Enable parsing for expressions
  )

# Print the plot
p2


```
<br>


As we miss most of the data points for low income countries we will focus on medium and high income countries and compare their opposite relationships

We first look at which other attributes define these countries in both income groups

insert correlation matrix

maybe extend to encompass also density of countries or better do the same just for density

#### Further questions and interpretations:

- High income countries can be further divided into high income & high pop where latter seems to result in 
- Overall trend: higher debt % positively correlates with higher % of basic education  
- medium income countries seem to suggest an opposite trend  
- High share of missing data, predominantely for low income countries


### Exploration of medium income countries
To explore why medium-income countries show an opposite (negative) trend in the relationship between central government debt and labor force education, we should consider a deeper analysis into factors that might drive this behavior.

<br>

**High Population & Medium Income Countries:**  

- Exhibit a strong negative correlation (-0.929) between debt and labor force education.  
- Interpretation: Larger countries may face challenges in allocating resources effectively to education despite increasing debt levels.
  
**Medium Population & Medium Income Countries:**  

- Show a moderate negative correlation (-0.704).  
- Interpretation: These countries may have mixed capacities to use debt effectively, possibly due to regional or governance differences.

**Low Population & Medium Income Countries:**  

- barely represented in medium income countries  
<br>

```{r group-by-population-density, echo = FALSE, warning=FALSE, message=FALSE}
print("Calculating correlation coefficients and data pair counts for each population density")
data_education %>%
  filter(cat_income_level == "Medium") %>%
  group_by(cat_population_density) %>%
  summarise(
    correlation = if (sum(!is.na(GC.DOD.TOTL.GD.ZS) & !is.na(SL.TLF.BASC.ZS)) >= 2) {
      cor(GC.DOD.TOTL.GD.ZS, SL.TLF.BASC.ZS, use = "complete.obs")
    } else {
      NA
    },
    data_pairs = sum(complete.cases(GC.DOD.TOTL.GD.ZS, SL.TLF.BASC.ZS))  # Count of valid data pairs
  )

```
<br>

**High Population Density & Medium Income:**  

- no medium income countries with high population density

**Medium Population Density & Medium Income:**  

- Trends are unclear, with little visible clustering of data points.  
- This group might represent countries with varying economic and governance conditions.  

**Low Population Density & Medium Income:**  

- Exhibit a strong negative trend, with labor force education decreasing as debt increases.  
- Interpretation: In sparsely populated areas, education infrastructure may be costly to maintain or expand, leading to less effective debt utilization.  


# sort this plot by income levels  not just with their color
<br>
```{r longitudinal_plot, fig.height=8, fig.width=12, echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data_education, 
       aes(x = Year, y = SL.TLF.BASC.ZS, color = cat_income_level)) +
  geom_line(aes(group = `Country Name`), alpha = 0.8, size = 0.7) +  # Line chart
  facet_wrap(~ `Country Name`) +  # Facet by country
  scale_x_continuous(breaks = seq(2000, 2020, 5)) +  # Simplify x-axis breaks
  labs(
    title = "Education Trends Over Time by Country",
    x = "Year",
    y = "Labor Force with Basic Education (%)",
    color = "Income Levels"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Bigger and centered title
    strip.text = element_text(size = 8, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    legend.position = "bottom"
  )


# Filter countries with for SL.TLF.BASC.ZS
data_filtered <- data_education %>%
  filter(cat_income_level == "Medium") %>%
  group_by(`Country Name`) %>%
  ungroup()

# Convert Year column to numeric
data_filtered <- data_filtered %>%
  mutate(Year = as.numeric(as.character(Year)))

# Calculate range of basic education percentage for each country
country_variability <- data_filtered %>%
  filter(!is.na(SL.TLF.BASC.ZS)) %>%  # Remove missing values
  group_by(`Country Name`) %>%
  summarise(
    min_education = min(SL.TLF.BASC.ZS, na.rm = TRUE),
    max_education = max(SL.TLF.BASC.ZS, na.rm = TRUE),
    range_education = max_education - min_education
  )

# View the results
print(country_variability)

```
<br>

#### Interpretations  
- insufficient data for most countries
- overall % with basic education drastically changing in consecutive years
- high fluctuation and variability in measurements questioning data quality




### 2 Labor Force Education and Pupil-Teacher ratios

In our previous analysis we highlighted sparsely populated countries that struggle with overall education quality. One driving factor in this might be pupil-teacher ratios.

<br>
For this we first look at the general relationship between basic education and pupil-teacher ratios:

```{r edu_555, message=FALSE, warning=FALSE, echo=FALSE}
# Scatter plot: pupil-teacher ratios vs labor force with basic education
ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Pupil-Teacher Ratio vs Labor Force with Basic Education",
    x = "Pupil-Teacher Ratio",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

p4 <- ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(aes(color = cat_population_density), alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  labs(
    title = "Schüler-Lehrer Relation vs Anteil grundlegender Bildung",
    x = "Schüler-Lehrer Relation",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  scale_color_manual(name = "Bevölkerungsdichte", values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"), labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")) +
  theme_bw()

p4
```

- densely populated countries tend to have better education quality
- sparsely populated countries tend to have lower pupil-teacher ratios
- variability in education quality decreases as pupil-teacher ratios increase
- small positive relationship between both variables

<br>
```{r edu_999, message=FALSE, warning=FALSE, echo=FALSE}
# Create a named vector to translate the facet levels
cor_matrix_2 <- data_education %>%
  group_by(cat_population_density) %>%
  summarise(
    correlation = round(cor(SE.TER.ENRL.TC.ZS, SL.TLF.BASC.ZS, method = "spearman", use = "complete.obs"), 2)
  )

# Merge correlations back into the original data for placement
data_with_cor <- data_education %>%
  left_join(cor_matrix_2, by = "cat_population_density")

facet_labels <- c(
  "Low" = "Niedrige Bevölkerungsdichte",
  "Medium" = "Mittlere Bevölkerungsdichte",
  "High" = "Hohe Bevölkerungsdichte"
)

# Update the facet_wrap function with the labeller argument
p5 <- ggplot(data_with_cor, aes(x = SE.TER.ENRL.TC.ZS, y = SL.TLF.BASC.ZS)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  facet_wrap(~ cat_population_density, labeller = labeller(cat_population_density = facet_labels)) +
  labs(
    title = "Schüler-Lehrer Relation vs Anteil grundlegender Bildung",
    x = "Schüler-Lehrer Relation",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme_bw() +
  geom_text(
    data = cor_matrix_2,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,  # Adjust horizontal alignment
    vjust = 1.5,  # Adjust vertical alignment
    size = 4,
    color = "black",
    parse = TRUE  # Enable parsing for expressions
  )

# Print the plot
p5


```
<br>

- densely populated countries tend to achieve better education with less pupils per teacher indicating higher monetary power

<br>

In order to assess education quality I will consider its effects on GDP per capita as it can be considered as a good approximation of economic output. closest estimate we have in the data set


```{r edu_102, warning=FALSE, message=FALSE, echo=FALSE}
ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = NY.GDP.PCAP.PP.KD, fill = cat_population_density)) +
  geom_point(shape = 21, alpha = 0.4) +
  geom_smooth(aes(color = cat_population_density), method = MASS::rlm,  se = FALSE, show.legend = FALSE) +
  scale_y_log10() +  # Apply log10 transformation to the x-axis
  labs(
    title = "Pupil-Teacher Ratio vs GDP per Capita (Log Scale)",
    x = "Pupil-Teacher Ratio",
    y = "GDP per Capita (Log Scale, USD)",
  ) +
  scale_fill_manual(name = "Population Density", values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

p6 <- ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = NY.GDP.PCAP.PP.KD, fill = cat_population_density)) +
  geom_point(shape = 21, alpha = 0.4) +
  geom_smooth(aes(color = cat_population_density), method = MASS::rlm,  se = FALSE, show.legend = FALSE) +
  scale_y_log10() +  # Apply log10 transformation to the x-axis
  labs(
    title = "Schüler-Lehrer Relation vs BIP pro Kopf",
    x = "Schüler-Lehrer Relation",
    y = "BIP pro Kopf [$] (log10)",
  ) +
  scale_fill_manual(name = "Bevölkerungsdichte", values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"), labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

p6
```
<br>
<br>
**High-Income Countries:**  

- The relationship between GDP per capita and labor force with basic education (%) is strongly positive, as evidenced by the steep slope for high-income countries.  
- High-income countries are concentrated at the higher end of the GDP scale.  

**Medium-Income Countries:**  

- Medium-income countries appear to have a much flatter relationship, with some variability in education outcomes across a wide range of GDP values.  

**Low-Income Countries:**  

- Low-income countries show a slightly negative or flat trend between GDP per capita and education levels.  
- These countries are clustered toward the lower GDP range, with varying education outcomes.  

