---
title: "Worldbank Education Analysis"
author: "Maximilian Frei"
date: "2025-01-20"
output:
  html_document: default
  pdf_document: default
---

## Introduction
This analysis explores relationships between indicators such as central government debt, labor force education levels, and pupil-teacher ratios using World Bank data. We are particular interested in these two research questions:

1. Do countries with **higher central government debt** as a percentage of GDP have a **lower percentage of labor force with basic education**? 
2. Are countries with **higher percentage of labor force with basic education** able to maintain **lower pupil-teacher ratios**, and what impact might this have on **education quality**?
<br>
```{r edu_setup, message=FALSE, echo=FALSE, include=FALSE}
# Load necessary libraries
library(here)
library(dplyr)
library(ggplot2)
library(tidyr)

# Load the dataset
data_merged <- readRDS(here("Data", "Processed", "data_merged.RDS"))
data_grouped <- readRDS(here("Data", "Processed", "data_grouped.RDS"))
data_education <- left_join(data_merged, data_grouped,
                            by = c("Country Name", "Country Code"))

# Filter only relevant columns
data_education <- data_education %>%
  select(
    `Country Name`, `Country Code`, Year, 
    GC.DOD.TOTL.GD.ZS, SL.TLF.BASC.ZS, SE.TER.ENRL.TC.ZS, 
    NY.GDP.PCAP.PP.KD, cat_income_level, cat_population_size, cat_population_density
  )

knitr::opts_chunk$set(fig.align = "center")
```



```{r edu_exploration, message=FALSE, echo=FALSE, include=FALSE}
# View the first few rows
head(data_education)

# Summary statistics of numerical columns
summary(data_education)

# Check for missing values
colSums(is.na(data_education))

# Check the structure of the dataset
str(data_education)

# Count the number of unique countries
data_education %>%
  distinct(`Country Name`) %>%
  count()
```

The dataset we've been provided is longitudinal: 

- 25 countries
- 18 indicators
- yearly observations from 2000 to 2021

Countries are classified into **quantiles** based on their **average values** for specific indicators. For this analysis, we group countries by **income level, population size, and population density**. 

<br>

| **Quantile**                      | Q1       | Q2   | Q3     | Q4   | Q5        |
|-----------------------------------|----------|------|--------|------|-----------|
| Prevalence of alcohol consumption | Very Low | Low  | Medium | High | Very High |
| Share of basic education          | Very Low | Low  | Medium | High | Very High |
| Population density                | \-       | Low  | Medium | High | \-        |
| Population size                   | \-       | Low  | Medium | High | \-        |
| Income level                      | \-       | Low  | Medium | High | \-        |
| Prevalence of tobacco consumption | Very Low | Low  | Medium | High | Very High |
| Surface area                      | Very Low | Low  | Medium | High | Very High |

```{r edu_missing_data, echo=FALSE, warning=FALSE}
# Summarize missing and non-missing data
data_missing <- data_education %>%
  group_by(cat_income_level) %>%
  summarise(
    debt_missing = sum(is.na(GC.DOD.TOTL.GD.ZS)),
    debt_not_missing = sum(!is.na(GC.DOD.TOTL.GD.ZS)),
    education_missing = sum(is.na(SL.TLF.BASC.ZS)),
    education_not_missing = sum(!is.na(SL.TLF.BASC.ZS))
  ) %>%
  pivot_longer(
    cols = c(debt_missing, debt_not_missing, education_missing, education_not_missing),
    names_to = c("variable", "status"),
    names_sep = "_",
    values_to = "count"
  )

# English Plot: Missing Data by Income Level
barplot_missing_data <- ggplot(data_missing,
                               aes(x = cat_income_level, y = count, fill = status)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~variable, labeller = as_labeller(c(
    "debt" = "Debt Data (GC.DOD.TOTL.GD.ZS)",
    "education" = "Education Data (SL.TLF.BASC.ZS)"
  ))) +
  labs(
    title = "Comparison of NA vs Not NA by Income Level",
    x = "Income Level",
    y = "Proportion",
    fill = "Data Status"
  ) +
  scale_fill_manual(values = c("red", "grey"), labels = c("Missing", "Not Missing")) +
  theme_bw()

# Display plot
barplot_missing_data

# Summarize available data pairs for each country
available_data_pairs <- data_education %>%
  group_by(`Country Name`) %>%
  summarise(
    available_pairs = sum(!is.na(GC.DOD.TOTL.GD.ZS) & !is.na(SL.TLF.BASC.ZS))
  ) %>%
  arrange(desc(available_pairs))

# Base plot: Available Data Pairs per Country
barplot_base_data_pairs <-
  ggplot(available_data_pairs,
         aes(x = reorder(`Country Name`, -available_pairs), y = available_pairs)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# English Plot: Available Data Pairs per Country
barplot_available_data_pairs <- barplot_base_data_pairs +
  labs(
    title = "Available Data Pairs (Government Debt & Basic Education)",
    x = "Country",
    y = "Number of Data Pairs"
  )

# Display plot
barplot_available_data_pairs

# German plot for presentation: Available Data Pairs per Country
pres_barplot_available_data_pairs <- barplot_base_data_pairs +
  labs(
    title = "Verfügbare Datenpaare (Staatliche Verschuldung & grundlegende Bildung)",
    x = "Land",
    y = "Anzahl Datenpaare"
  )

```

<br>
```{r edu_trend_country, fig.height=8, fig.width=12, echo=FALSE, warning=FALSE, message=FALSE}

# Reorder the Country Name based on the income level
data_education_reordered <- data_education %>%
  arrange(cat_income_level, `Country Name`) %>%
  mutate(`Country Name` = factor(`Country Name`, unique(`Country Name`)))

# Base plot for education trends over time
lineplot_base_edu_trend <- ggplot(data_education_reordered, 
             aes(x = Year, y = SL.TLF.BASC.ZS, color = cat_income_level)) +
  geom_line(aes(color = cat_income_level, group = `Country Name`),
            alpha = 0.8, size = 0.7) +  # Line chart
  facet_wrap(~ `Country Name`) +  # Facet by country
  scale_x_continuous(breaks = seq(2000, 2020, 5)) +  # Simplify x-axis breaks
  scale_fill_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

# English Plot: Share of Basic Education Over the Years
lineplot_edu_trend_country <- lineplot_base_edu_trend +
  labs(
    title = "Share of Basic Education Over the Years",
    x = "Year",
    y = "Labor Force with Basic Education [%]",
    color = "Income Level"
  )

# Display plot
lineplot_edu_trend_country

# German Plot for presentation: Share of Basic Education Over the Years
pres_lineplot_edu_trend_country <- lineplot_base_edu_trend +
  labs(
    title = "Bildungsentwicklung über die Jahre",
    x = "Jahr",
    y = "Erwerbstätige mit grundlegender Bildung [%]",
    color = "Einkommensniveau"
  ) +
  scale_color_manual(
    name = "Einkommensniveau",
    values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"),
    labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")
  ) +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5),  # Bigger and centered title
    strip.text = element_text(size = 10),
    axis.title = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    legend.position = "bottom",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 14)
  )
```
<br>

#### Data quality concerns
A deeper look at the dataset reveals significant limitations:

- Only **10 countries** have complete data, leading to **uneven representation**.
- The **percentage of labor force with basic education** fluctuates drastically across consecutive years in several countries, **raising concerns about data reliability**. 

To mitigate these issues, we employ robust statistical techniques, including:

- **Robust Linear Models (RLMs)** for trend estimation, which are less sensitive to **outliers**.
- **Confidence Intervals** to provide insight into the **uncertainty of our estimates**.
- **Spearman correlation coefficients** to quantify relationships, as they are **resistant to non-normality** and **unevenly spaced values**. 

<br>

#### Robust Linear Models

Traditional **Ordinary Least Squares (OLS)** estimates regression coefficients by minimizing the sum of squared residuals:

$$
\min_{\beta} \sum_{i=1}^{n} (y_i - X_i \beta)^2
$$

This approach provides **BLUE (Best Linear Unbiased Estimators)** under the **Gauss-Markov theorem**, but relies on the assumption that residuals are **normally distributed**. Given the inconsistencies in our dataset, this assumption is likely invalid. While OLS estimates remain **unbiased** but may become less efficient, potentially affecting the reliability of **confidence intervals and hypothesis tests**.

To address this, we use **Robust Linear Models (RLMs)**, specifically M-estimators, as implemented in `MASS::rlm()`. These models apply **Iteratively Reweighted Least Squares (IRLS)**, assigning smaller weights to outliers. Instead of minimizing squared residuals, RLMs use **alternative loss functions** that reduce the impact of extreme values.

In our analysis, we use the default psi function, **psi.huber**, which is based on **Huber’s loss function**:

$$
L_{\delta}(r) =
\begin{cases} 
\frac{1}{2} r^2  & \text{for } |r| \leq \delta, \\
\delta (|r| - \frac{1}{2} \delta)  & \text{for } |r| > \delta.
\end{cases}
$$

where:

- \( r \) is the **residual** \(y_i - X_i \beta\)
- \( \delta \) is the **threshold parameter** (default in R: **1.345**)  

This method ensures **small residuals** behave like **OLS**, while **large residuals** have **reduced influence**, making RLMs more resistant to **outliers and non-normal residual distributions**.

<br>

#### Confidence Intervals

By default, `geom_smooth(method = MASS::rlm)` displays confidence intervals. However, unlike **ordinary least squares (OLS)**, `MASS::rlm()` does **not automatically provide standard errors**, as robust regression does not make the same assumptions about variability in the data.  

The confidence intervals shown in `geom_smooth()` are based on an **approximation** rather than **true robust standard errors**. Specifically, `ggplot2` estimates confidence intervals using the **standard formula for least squares regression**:

$$
CI = \hat{y} \pm t_{\alpha/2, df} \cdot SE(\hat{y})
$$


where:

- \( \hat{y} \) is the **predicted value** from the robust regression model
- \( SE(\hat{y}) \) is the **standard error of the fitted values**, approximated using **local smoothing techniques**
- \( t_{\alpha/2, df} \) is the **critical t-value** for a 95% confidence level

Since robust regression methods like `rlm()` do not inherently calculate standard errors, the confidence intervals shown by `geom_smooth()` are **only an approximation**. A more rigorous approach would involve computing **robust standard errors manually** using the **Huber-White sandwich estimator** or **bootstrapping techniques**.

For simplicity, we retain the default confidence bands provided by `geom_smooth()`, while acknowledging that they do not fully account for the robustness adjustments of `rlm()`.


<br>

#### Spearman Correlation

The **Spearman correlation coefficient** measures the **monotonic relationship** between two variables. Unlike **Pearson correlation**, which captures only **linear relationships**, Spearman correlation assesses whether as one variable increases, the other tends to increase or decrease in a consistent order.

$$
\rho = 1 - \frac{6 \sum d_i^2}{n(n^2 - 1)}
$$
where:

- \( d_i \) is the difference between the ranks of the corresponding values of the two variables 
- \( n \) is the number of observations 

Since **Spearman correlation** operates on **ranked data**, it is **less sensitive to outliers and non-normal distributions**, making it particularly useful given the data quality concerns in our analysis.

<br>

### 1 Central Government Debt and Labor Force Education
We now examine whether countries with **higher central government debt (as % of GDP)** have **lower percentages of labor force with basic education**.

To visualize the general relationship, we plot a scatter plot with a robust linear model trend line.

```{r edu_scatter_debt_edu, message=FALSE, echo=FALSE, warning=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
scatter_base_debt_edu <-
  ggplot(data_education, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

# Adding robust linear regression line
scatter_debt_edu <- scatter_base_debt_edu +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  theme_bw()

# Display plot
scatter_debt_edu

```


```{r edu_scatter-debt-edu-years, echo=FALSE, warning=FALSE, message=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
scatter_debt_edu_years <- scatter_base_debt_edu +
  geom_point(alpha = 0.6) +
  facet_wrap(~ Year) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black")

scatter_debt_edu_years
```

<br>

### Interpretation 
At first glance, there appears to be a **positive relationship** between central government debt and labor force education over time. However, due to the high proportion of missing data, further investigation is required. 

Analyzing this relationship by income levels is a logical next step, as income significantly impacts a country's ability to invest in education and manage debt. This approach can reveal how economic disparities influence the correlation and highlight potential structural inequalities.

<br>

```{r edu_scatter_debt_edu_income, echo=FALSE, , warning=FALSE, message=FALSE}
# Scatter plot: Central government debt vs labor force with basic education
scatter_color_debt_edu_income <- scatter_base_debt_edu +
  geom_point(alpha = 0.6) +
  aes(color = cat_income_level) +
  scale_fill_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(color = "Income Level")

# Display plot
scatter_color_debt_edu_income

# Base German plot for presentation: Central government debt vs labor force with basic education
scatter_color_base_pres <- scatter_base_debt_edu +
  aes(color = cat_income_level) +
  geom_point(size = 3.5, alpha = 0.6) +
  scale_color_manual(
    name = "Einkommensniveau",
    values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"),
    labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")
  ) +
  labs(
    x = "Zentralstaatliche Verschuldung [% des BIP]",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20)
  ) +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

# German plot for presentation: Central government debt vs labor force with basic education (Default)
pres_scatter_color_debt_edu_income <- scatter_color_base_pres +
  geom_smooth(aes(color = cat_income_level),
              method = MASS::rlm, se = FALSE, color = "black") +
  labs(title = "Zentralstaatliche Verschuldung vs. Grundbildung") +
  theme(
    legend.text = element_text(size = 14),
    legend.title = element_text(hjust = 0.5, size = 14),
  )

# German plot for presentation (Updated)
pres_upd_scatter_color_debt_edu_income <- scatter_color_base_pres +
  geom_smooth(aes(color = cat_income_level),
              method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(title = "Zentralstaatliche Verschuldung und Grundbildung") +
  theme(
    legend.text = element_text(size = 18),
    legend.title = element_text(hjust = 0.5, size = 18),
  )
```

<br>

We observe a distinct clustering of data points among **medium-income countries**, which appear to exhibit **opposite trends**. To better visualize these relationships, we will create **faceted plots** for each income level, allowing for a clearer comparison between subgroups.

<br>
```{r edu_scatter_faceted_debt_edu_income, echo=FALSE, message=FALSE, warning=FALSE}
# Calculate correlations for each income level
cor_matrix_1 <- data_education %>%
  group_by(cat_income_level) %>%
  summarise(
    correlation = round(cor(GC.DOD.TOTL.GD.ZS, SL.TLF.BASC.ZS,
                            method = "spearman", use = "complete.obs"), 2)
  )

# Merge correlations back into the original data
data_with_cor <- left_join(data_education, cor_matrix_1, by = "cat_income_level")

# Define German income level labels
income_labels <- c(
  "Low" = "Geringes Einkommen",
  "Medium" = "Mittleres Einkommen",
  "High" = "Hohes Einkommen"
)

# Base faceted scatter plot: Debt vs Education by Income Level
scatter_faceted_base <-
  ggplot(data_with_cor, aes(x = GC.DOD.TOTL.GD.ZS, y = SL.TLF.BASC.ZS)) +
  facet_wrap(~ cat_income_level) +
  theme_bw()

# English plot: Faceted scatter plot of Debt vs Education by Income Level
scatter_faceted_debt_edu_income <- scatter_faceted_base +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Central Government Debt (% of GDP)",
    y = "Labor Force with Basic Education (%)"
  ) + 
  geom_text(
    data = cor_matrix_1,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,
    vjust = 1.5,
    size = 4.5,
    color = "black",
    parse = TRUE
  )

# Display plot
scatter_faceted_debt_edu_income

# German plot for presentation: Faceted scatter plot of Debt vs Education by Income Level
pres_scatter_faceted_debt_edu_income <- scatter_faceted_base +
  geom_point(size = 3.5, alpha = 0.6) +
  facet_wrap(~ cat_income_level, labeller = labeller(cat_income_level = income_labels)) +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black", size = 1.5) +
  labs(
    title = "Zentralstaatliche Verschuldung vs. Grundbildung",
    x = "Zentralstaatliche Verschuldung [% des BIP]",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    legend.text = element_text(size = 14),
    legend.title = element_text(hjust = 0.5, size = 14),
    plot.title = element_text(hjust = 0.5, size = 20),
    strip.text = element_text(size = 14)
  ) +
  geom_text(
    data = cor_matrix_1,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,
    vjust = 1.5,
    size = 6,
    color = "black",
    parse = TRUE
  )

# German plot for presentation (Updated)
pres_upd_scatter_faceted_debt_edu_income <- pres_scatter_faceted_debt_edu_income +
  geom_smooth(method = MASS::rlm, color = "black", size = 1.5, alpha = 0.2) +
  labs(
    title = "Zentralstaatliche Verschuldung und Grundbildung",
  ) +
  theme(
    legend.text = element_text(size = 18),
    legend.title = element_text(hjust = 0.5, size = 18)
  )
```
<br>


Due to the **significant lack of data** for **low-income countries**, we are unable to draw any meaningful conclusions for this group.  

Interestingly, **medium- and high-income countries** exhibit **completely opposite trends** in the relationship between **debt and labor force education**. To explore potential influencing factors and gain deeper insights into **shared characteristics**, we further segment countries **by population size**.  

In the **correlation matrix** below, **grey tiles indicate** cases where **fewer than 10 data pairs** are available, highlighting areas with limited data reliability.

```{r edu_correlation_matrix, echo=FALSE, message=FALSE, warning=FALSE}
data_education_cor <- data_education %>%
  group_by(cat_income_level, cat_population_size) %>%
  summarise(
    count_pairs = sum(!is.na(GC.DOD.TOTL.GD.ZS) &
                        !is.na(SL.TLF.BASC.ZS)), # Count complete data pairs
    correlation = tryCatch({
      round(cor(
        GC.DOD.TOTL.GD.ZS,
        SL.TLF.BASC.ZS,
        method = "spearman",
        use = "complete.obs"
      ), 2)
    }, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(correlation = ifelse(count_pairs < 10,
                              NA, correlation)) # Set correlation to NA if <10 pairs

# Convert to tidy format for plotting
data_education_tidy <- data_education_cor %>%
  mutate(
    cat_income_level =
      factor(cat_income_level,
             levels = rev(c("High", "Medium", "Low"))), # Reverse Income order
    cat_population_size =
      factor(cat_population_size,
             levels = rev(c("High", "Medium", "Low"))) # Reverse Population order
  )

# Create heatmap with dynamically calculated correlation coefficients
cor_matrix_debt_edu <-
  ggplot(data_education_tidy,
         aes(x = cat_income_level, y = cat_population_size, fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = ifelse(is.na(correlation), "", round(correlation, 2))),
            color = "black") + # Add text labels
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    limit = c(-1, 1), na.value = "grey80",
    name = "Spearman\nKorrelation" # Use grey for missing values
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(vjust = 1, hjust = 1)
  ) +
  labs(
    title = "Central Government Debt vs Labor Force with Basic Education",
    x = "Income Level",
    y = "Population Size"
  )

# Display plot
cor_matrix_debt_edu

data_education_tidy_de <- data_education_tidy %>%
  mutate(
    cat_income_level = recode(cat_income_level,
                              "High" = "Hoch", "Medium" = "Mittel", "Low" = "Gering"),
    cat_population_size = recode(cat_population_size,
                                 "High" = "Hoch", "Medium" = "Mittel", "Low" = "Gering")
  )

# German plot for presentation: Create heatmap with dynamically calculated correlation
# coefficients
pres_cor_matrix_debt_edu <-
  ggplot(data_education_tidy_de,
         aes(x = cat_income_level, y = cat_population_size, fill = correlation)) +
  geom_tile(color = "white") +
  geom_text(aes(label = ifelse(is.na(correlation), "", round(correlation, 2))),
            color = "black", size = 6) + # Add text labels
  scale_fill_gradient2(
    low = "blue", mid = "white", high = "red", midpoint = 0,
    limit = c(-1, 1), na.value = "grey80",
    name = "Spearman\nKorrelation" # Use grey for missing values
  ) +
  theme_bw() +
  labs(
    title = "Zentralstaatliche Verschuldung vs. Grundbildung",
    x = "Einkommensniveau",
    y = "Einwohnerzahl"
  ) +
  theme(axis.text.x = element_text(hjust = 0.5, size = 14),
        axis.text.y = element_text(vjust = 0.5, size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        legend.key.height = unit(1, "cm"),
        legend.key.width = unit(1, "cm"),
        legend.text = element_text(size = 14),
        legend.title = element_text(hjust = 0.5, size = 14, margin = margin(b = 20)),
        panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 20))

pres_upd_cor_matrix_debt_edu <- pres_cor_matrix_debt_edu +
  labs(title = "Zentralstaatliche Verschuldung und Grundbildung")

```

#### Further Questions and Interpretations:  

- In **medium-income countries**, the negative correlation between **debt and labor force education** strengthens as **population size increases**.  
- This pattern is **not observed** in **high-income countries**, where a strong relationship is only evident in **large-population nations**.  
- The **overall positive correlation** may be influenced by the **disproportionate representation** of **high-income, high-population countries** in the dataset, potentially skewing the results.

<br>

### Conclusion  

1. **Do countries with higher central government debt as a percentage of GDP have a lower percentage of labor force with basic education?**  

While our initial hypothesis suggested a **negative relationship**, the data instead reveals an **overall positive correlation** between **debt and labor force education**. However, this relationship is **not uniform** and varies significantly based on **income level and population size**. These findings highlight the need for a **more nuanced approach**, as structural and economic factors likely play a crucial role in shaping this connection.


### **2. Labor Force Education and Pupil-Teacher Ratios**  

To begin, we examine the **overall relationship** between **basic education levels** and **pupil-teacher ratios** to identify any broad trends before diving into more detailed subgroup analyses.

```{r edu_teacher_edu, message=FALSE, warning=FALSE, echo=FALSE}
# Scatter plot: pupil-teacher ratios vs labor force with basic education
scatter_teacher_edu_base <-
  ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = SL.TLF.BASC.ZS)) +
  labs(
    title = "Pupil-Teacher Ratio vs Labor Force with Basic Education",
    x = "Pupil-Teacher Ratio",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

# Display plot
scatter_teacher_edu <- scatter_teacher_edu_base +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  geom_point(alpha = 0.6)

scatter_teacher_edu
```

We observe a **weaker but still positive relationship** between **basic education levels and pupil-teacher ratios**.  

The **pupil-teacher ratio** serves as an **indicator of available educational resources**, with **higher ratios suggesting limited resources**, as fewer teachers are available per student.  

To further investigate this relationship, we analyze it **by population density**, as sparsely populated or remote regions may face **greater challenges in allocating educational resources** compared to **densely populated areas**, where resource distribution may be more efficient.

```{r edu_teacher_edu_color, message=FALSE, warning=FALSE, echo=FALSE}
# Scatter plot: pupil-teacher ratios vs labor force with basic education
scatter_color_teacher_edu <- scatter_teacher_edu_base +
  geom_point(aes(color = cat_population_density), alpha = 0.6) +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  scale_color_manual(name = "Population density",
                     values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

# Display plot
scatter_color_teacher_edu

# Base presentation format
scatter_color_teacher_edu_de <- scatter_teacher_edu_base +
  geom_point(aes(color = cat_population_density), size = 3.5, alpha = 0.6) +
  labs(
    title = "Schüler-Lehrer-Relation vs. Grundbildung",
    x = "Schüler-Lehrer-Relation",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  scale_color_manual(name = "Bevölkerungsdichte",
                     values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"),
                     labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")) +
  theme_bw() +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        plot.title = element_text(hjust = 0.5, size = 20)) +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

# German plot for presentation: Scatter plot: pupil-teacher ratios vs labor force with
# basic education
pres_scatter_color_teacher_edu <- scatter_color_teacher_edu_de +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black") +
  theme(
        legend.text = element_text(size = 14),
        legend.title = element_text(hjust = 0.5, size = 14),
  )

# German plot for presentation: Scatter plot: pupil-teacher ratios vs labor force with
# basic education
pres_upd_scatter_color_teacher_edu <- scatter_color_teacher_edu_de +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(
    title = "Schüler-Lehrer-Relation und Grundbildung"
  ) +
  theme_bw() +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(hjust = 0.5, size = 18),
        plot.title = element_text(hjust = 0.5, size = 20)) +
  guides(color = guide_legend(override.aes = list(alpha = 1)))

```

#### First Impressions:  

- **Densely populated countries** tend to have **higher education quality**.  
- **Sparsely populated countries** generally have **lower pupil-teacher ratios**.  
- **Variability in education quality** decreases as **pupil-teacher ratios increase**.  

To better highlight differences between **subgroups** and compute **individual Spearman correlation coefficients**, we will **facet the plot** by **population density**.

<br>
```{r edu_teacher_edu_facets, message=FALSE, warning=FALSE, echo=FALSE}
# Create a named vector to translate the facet levels
cor_matrix_2 <- data_education %>%
  group_by(cat_population_density) %>%
  summarise(
    correlation = round(cor(SE.TER.ENRL.TC.ZS, SL.TLF.BASC.ZS,
                            method = "spearman", use = "complete.obs"), 2)
  )

# Merge correlations back into the original data for placement
data_with_cor <- data_education %>%
  left_join(cor_matrix_2, by = "cat_population_density")

# Define German labels for population density categories
facet_labels <- c(
  "Low" = "Niedrige Bevölkerungsdichte",
  "Medium" = "Mittlere Bevölkerungsdichte",
  "High" = "Hohe Bevölkerungsdichte"
)

# Base faceted scatter plot: Pupil-Teacher Ratio vs Labor Force with Basic Education
scatter_faceted_base <-
  ggplot(data_with_cor, aes(x = SE.TER.ENRL.TC.ZS, y = SL.TLF.BASC.ZS)) +
  facet_wrap(~ cat_population_density) +
  labs(
    x = "Pupil-Teacher Ratio",
    y = "Labor Force with Basic Education (%)"
  ) +
  theme_bw()

# English plot: Pupil-Teacher Ratio vs Labor Force with Basic Education
scatter_faceted_teacher_edu <- scatter_faceted_base +
  geom_point(alpha = 0.6) +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(title = "Pupil-Teacher Ratio vs Labor Force with Basic Education") +
  geom_text(
    data = cor_matrix_2,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,
    vjust = 1.5,
    size = 4.5,
    color = "black",
    parse = TRUE
  )

# Display plot
scatter_faceted_teacher_edu

# German base plot (adds German facet labels)
scatter_faceted_base_de <- scatter_faceted_base +
  geom_point(size = 3.5, alpha = 0.6) +
  facet_wrap(~ cat_population_density,
             labeller = labeller(cat_population_density = facet_labels)) +
  labs(
    title = "Schüler-Lehrer-Relation vs. Grundbildung",
    x = "Schüler-Lehrer-Relation",
    y = "Erwerbstätige mit grundlegender Bildung [%]"
  ) +
  theme(
    axis.text = element_text(size = 14),
    axis.title.x = element_text(margin = margin(t = 10), size = 18),
    axis.title.y = element_text(margin = margin(r = 10), size = 18),
    plot.title = element_text(hjust = 0.5, size = 20),
    strip.text = element_text(size = 14)
  ) +
  geom_text(
    data = cor_matrix_2,
    aes(
      x = Inf, 
      y = Inf, 
      label = paste0("italic(r)[s] == ", correlation)
    ),
    inherit.aes = FALSE,
    hjust = 1.1,
    vjust = 1.5,
    size = 6,
    color = "black",
    parse = TRUE
  )

# German plot for presentation
pres_scatter_faceted_teacher_edu <- scatter_faceted_base_de  +
  geom_smooth(method = MASS::rlm, se = FALSE, color = "black")

# Updated German plot for presentation
pres_upd_scatter_faceted_teacher_edu <- scatter_faceted_base_de  +
  geom_smooth(method = MASS::rlm, color = "black", alpha = 0.2) +
  labs(title = "Schüler-Lehrer-Relation und Grundbildung")

```
<br>

Contrary to intuition, a **lower pupil-teacher ratio** does not necessarily correspond to a **higher percentage of the labor force with basic education**, particularly in **sparsely populated countries**. This suggests that **other influencing factors** may play a more significant role. However, in **high-density populations**, the expected relationship becomes more apparent.  

<br>  

Assessing **education quality** is inherently complex, as its definition depends on the perspective taken and the weight assigned to various contributing factors.  

For our analysis, we adopt an **economic perspective**, using **GDP per capita (USD)** as a **proxy for economic output**, which serves as a reasonable indicator of a country’s overall educational effectiveness and workforce potential.


```{r edu_teacher_gdp, warning=FALSE, message=FALSE, echo=FALSE}
# Scatter plot: Pupil-Teacher Ratio vs GDP per Capita (Log Scale)
scatter_color_teacher_gdp_base <-
  ggplot(data_education, aes(x = SE.TER.ENRL.TC.ZS, y = NY.GDP.PCAP.PP.KD,
                             fill = cat_population_density)) +
  labs(
    title = "Pupil-Teacher Ratio vs GDP per Capita",
    x = "Pupil-Teacher Ratio",
    y = "GDP per Capita",
  ) +
  scale_fill_manual(name = "Population Density",
                    values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  scale_color_manual(values = c("#F89441FF", "#CC4678FF", "#7E03A8FF")) +
  theme_bw()

scatter_color_teacher_gdp <- scatter_color_teacher_gdp_base +
  geom_point(shape = 21, alpha = 0.4) +
  geom_smooth(aes(color = cat_population_density),
              method = MASS::rlm, show.legend = FALSE, alpha = 0.2) +
  scale_y_log10(
    breaks = c(10, 100, 1000, 10000, 100000),
    labels = c("10", "100", "1.000", "10.000", "100.000")
  ) + 
  labs(y = "GDP per Capita (Log Scale, USD)")

scatter_color_teacher_gdp

# German plot for presentation: Scatter plot of Pupil-Teacher Ratio vs GDP per Capita
# (Log Scale)
pres_scatter_color_teacher_gdp_base <- scatter_color_teacher_gdp_base +
  geom_point(size = 3.5, shape = 21, alpha = 0.4) +
  geom_smooth(aes(color = cat_population_density),
              method = MASS::rlm,  se = FALSE, show.legend = FALSE) +
  scale_y_log10() +  # Apply log10 transformation to the x-axis
  labs(
    title = "Schüler-Lehrer-Relation vs BIP pro Kopf",
    x = "Schüler-Lehrer-Relation",
    y = "BIP pro Kopf [$] (Log10)",
  ) +
  scale_fill_manual(name = "Bevölkerungsdichte",
                    values = c("#F89441FF", "#CC4678FF", "#7E03A8FF"),
                    labels = c("Low" = "Gering", "Medium" = "Mittel", "High" = "Hoch")) +
  theme(axis.text = element_text(size = 14),
        axis.title.x = element_text(margin = margin(t = 10), size = 18),
        axis.title.y = element_text(margin = margin(r = 10), size = 18),
        legend.text = element_text(size = 14),
        legend.title = element_text(hjust = 0.5, size = 14),
        plot.title = element_text(hjust = 0.5, size = 20)) +
  guides(fill = guide_legend(override.aes = list(alpha = 1)))

pres_scatter_color_teacher_gdp <- pres_scatter_color_teacher_gdp_base +
  theme(legend.text = element_text(size = 14),
        legend.title = element_text(hjust = 0.5, size = 14))
  
# German plot for updated presentation: Scatter plot of Pupil-Teacher Ratio vs GDP per
# Capita (Log Scale)
pres_upd_scatter_color_teacher_gdp <- pres_scatter_color_teacher_gdp_base +
  geom_smooth(aes(color = cat_population_density),
              method = MASS::rlm, show.legend = FALSE, alpha = 0.2) +
  scale_y_log10(
    breaks = c(10, 100, 1000, 10000, 100000),
    labels = c("10", "100", "1.000", "10.000", "100.000")
  ) +
  labs(
    title = "Schüler-Lehrer-Relation und BIP pro Kopf",
  ) +
  theme(
    legend.text = element_text(size = 18),
    legend.title = element_text(hjust = 0.5, size = 18)
  )

```
<br>

### Conclusion 


2. Are countries with **higher percentage of labor force with basic education** able to maintain **lower pupil-teacher ratios**, and what impact might this have on **education quality**?  
<br>

While one might expect that a lower pupil-teacher ratio would correlate with a higher percentage of the labor force having basic education, this pattern does not hold in sparsely populated countries. Instead, other factors appear to influence this relationship, suggesting that pupil-teacher ratios alone may not be a reliable indicator of educational resources in these regions. However, in countries with **high population density**, the expected relationship becomes more apparent.  

- The anticipated effect emerges primarily in **densely populated countries**, where a lower pupil-teacher ratio aligns with a more educated workforce.  
- In **sparsely populated countries**, pupil-teacher ratios do not necessarily reflect the level of educational investment or available resources, indicating that other structural or economic factors may play a more significant role.

```{r edu_save_png, error=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Save all the graphics used during this markdown analysis to list of lists where each
# list contains the individual parameters for ggsave
pngs <- list(
  list(file = "barplot_missing_data.png", plot = barplot_missing_data,
       height = 8, width = 14),
  list(file = "barplot_available_data_pairs.png", plot = barplot_available_data_pairs,
       height = 8, width = 14),
  list(file = "pres_barplot_available_data_pairs.png",
       plot = pres_barplot_available_data_pairs, height = 8, width = 14),
  list(file = "lineplot_edu_trend_country.png", plot = lineplot_edu_trend_country,
       height = 8, width = 14),
  list(file = "pres_lineplot_edu_trend_country.png",
       plot = pres_lineplot_edu_trend_country, height = 8, width = 14),
  list(file = "scatter_debt_edu.png", plot = scatter_debt_edu,
       height = 8, width = 14),
  list(file = "scatter_debt_edu_years.png", plot = scatter_debt_edu_years,
       height = 8, width = 14),
  list(file = "scatter_color_debt_edu_income.png", plot = scatter_color_debt_edu_income,
       height = 8, width = 14),
  list(file = "pres_scatter_color_debt_edu_income.png",
       plot = pres_scatter_color_debt_edu_income, height = 8, width = 14),
  list(file = "pres_upd_scatter_color_debt_edu_income.png",
       plot = pres_upd_scatter_color_debt_edu_income, height = 8, width = 14),
  list(file = "scatter_faceted_debt_edu_income.png",
       plot = scatter_faceted_debt_edu_income, height = 8, width = 14),
  list(file = "pres_scatter_faceted_debt_edu_income.png",
       plot = pres_scatter_faceted_debt_edu_income, height = 8, width = 14),
  list(file = "pres_upd_scatter_faceted_debt_edu_income.png",
       plot = pres_upd_scatter_faceted_debt_edu_income, height = 8, width = 14),
  list(file = "cor_matrix_debt_edu.png", plot = cor_matrix_debt_edu,
       height = 8, width = 14),
  list(file = "pres_cor_matrix_debt_edu.png", plot = pres_cor_matrix_debt_edu,
       height = 8, width = 14),
  list(file = "pres_upd_cor_matrix_debt_edu.png", plot = pres_upd_cor_matrix_debt_edu,
       height = 8, width = 14),
  list(file = "scatter_teacher_edu.png", plot = scatter_teacher_edu,
       height = 8, width = 14),
  list(file = "scatter_color_teacher_edu.png", plot = scatter_color_teacher_edu,
       height = 8, width = 14),
  list(file = "pres_scatter_color_teacher_edu.png", plot = pres_scatter_color_teacher_edu,
       height = 8, width = 14),
  list(file = "pres_upd_scatter_color_teacher_edu.png",
       plot = pres_upd_scatter_color_teacher_edu, height = 8, width = 14),
  list(file = "scatter_faceted_teacher_edu.png", plot = scatter_faceted_teacher_edu,
       height = 8, width = 14),
  list(file = "pres_scatter_faceted_teacher_edu.png",
       plot = pres_scatter_faceted_teacher_edu, height = 8, width = 14),
  list(file = "pres_upd_scatter_faceted_teacher_edu.png",
       plot = pres_upd_scatter_faceted_teacher_edu, height = 8, width = 14),
  list(file = "scatter_color_teacher_gdp.png", plot = scatter_color_teacher_gdp,
       height = 8, width = 14),
  list(file = "pres_scatter_color_teacher_gdp.png", plot = pres_scatter_color_teacher_gdp,
       height = 8, width = 14),
  list(file = "pres_upd_scatter_color_teacher_gdp.png",
       plot = pres_upd_scatter_color_teacher_gdp, height = 8, width = 14)
)

# Use lapply to apply ggsave to each element in the list
lapply(pngs, function(x) {
  ggsave(filename = x$file, plot = x$plot, path = here("Results", "Education"),
         height = x$height, width = x$width, device = "png", dpi = 320, bg = "white")
})
```
